---
import Layout from "../../layouts/Layout.astro";
import Button from "../../components/ui/Button.astro";
import ProgramTabs from "../../components/program/ProgramTabs.astro";
import ProgramPainPoints from "../../components/program/ProgramPainPoints.astro";
import ProgramWhyUs from "../../components/program/ProgramWhyUs.astro";
import ProgramTarget from "../../components/program/ProgramTarget.astro";
import ProgramCurriculum from "../../components/program/ProgramCurriculum.astro";
import ProgramProcess from "../../components/program/ProgramProcess.astro";
import ProgramFAQ from "../../components/program/ProgramFAQ.astro";

export async function getStaticPaths() {
  const WP_BASE = (import.meta.env.PUBLIC_WP_BASE_URL || "").replace(/\/$/, "");
  if (!WP_BASE) throw new Error("PUBLIC_WP_BASE_URL is not set");

  const url = `${WP_BASE}/wp-json/wp/v2/program?per_page=100&_fields=slug`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`WP REST error ${res.status}: ${url}`);

  const programs = await res.json();

  return programs.map((p) => ({
    params: { slug: p.slug },
  }));
}

// Page data fetch (inline)
const WP_BASE = (import.meta.env.PUBLIC_WP_BASE_URL || "").replace(/\/$/, "");
if (!WP_BASE) throw new Error("PUBLIC_WP_BASE_URL is not set");

const { slug } = Astro.params;

const detailUrl = `${WP_BASE}/wp-json/wp/v2/program?slug=${encodeURIComponent(slug)}` + `&_fields=slug,title,program_description,program_type_tabs`;

const detailRes = await fetch(detailUrl);
if (!detailRes.ok) throw new Error(`WP REST error ${detailRes.status}: ${detailUrl}`);

const arr = await detailRes.json();
const program = arr?.[0];

if (!program) throw new Error("Program not found");

const title = program.title?.rendered ?? "Program";
const descriptionHtml = program.program_description ?? "";
const programTypeTabs = program.program_type_tabs ?? "";
---

<Layout title={title}>
  <main>
    {/* HERO SECTION */}
    <section class="relative pt-32 pb-12 bg-hero-gradient overflow-hidden lg:max-h-[300px] lg:flex lg:items-center mb-10">
      <!-- Decorative element -->
      <div class="absolute inset-0 hidden lg:flex pointer-events-none z-10">
        <div class="container mx-auto w-full flex items-end justify-end">
          <div class="relative w-[35%] h-full flex flex-col items-center justify-end">
            <!-- Semi-circle background -->
            <div class="absolute top-0 w-[360px] h-[180px] bg-ultimate-yellow rounded-b-full left-1/3 -translate-y-[54px] z-0"></div>
            <!-- Hero Image Overlay -->
            <img src="/images/hero_img.png" alt="Ilustrasi siswa belajar" class="absolute z-10 h-[85%] w-auto object-contain object-bottom left-[73%] -translate-x-1/2" />
          </div>
        </div>
      </div>
      <!-- Background Patterns -->

      <div class="w-full relative z-20 text-left">
        <div class="container mx-auto pt-8 lg:pt-10">
          <div class="lg:w-1/2 max-w-2xl">
            <h1 class="font-heading font-semibold text-white text-3xl md:text-4xl lg:text-5xl mb-4 leading-snug" set:html={title} />
          </div>
        </div>
      </div>
    </section>

    {/* TABS SECTION */}
    {
      programTypeTabs && (
        <section class="container mx-auto max-w-7xl mb-12">
          <ProgramTabs content={programTypeTabs} />
        </section>
      )
    }

    {/* CONTENT SECTIONS */}
    <section class="container mx-auto max-w-7xl space-y-10">
      <ProgramPainPoints />
      <ProgramWhyUs />
      <ProgramTarget />
      <ProgramCurriculum />
      <ProgramProcess />
      <ProgramFAQ />
    </section>

    {/* CTA SECTION */}
    <section class="container mx-auto max-w-7xl mt-16 flex justify-center">
      <Button href="/contact" class="bg-blue-900 text-white hover:bg-yellow-300 hover:text-blue-900 font-medium py-4 px-8 rounded-xl shadow-lg transition-all text-lg">Konsultasi Gratis</Button>
    </section>
  </main>
</Layout>
