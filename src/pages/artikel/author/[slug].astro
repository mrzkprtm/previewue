---
/**
 * OWNER: DYNAMIC (Dev B)
 * Author archive page - Dynamic SSR mode for any author.
 */
import Layout from "../../../layouts/Layout.astro";
import ArticleCard from "../../../components/blog/ArticleCard.astro";
import Pagination from "../../../components/blog/Pagination.astro";
import type { WPPost, WPAuthor } from "../../../types/wp";

// Use prerender = false for dynamic author pages
export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/artikel");
}

// Convert slug to display name
function slugToName(s: string): string {
    return s
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
}

let author: { id: number; name: string; slug: string; description?: string; avatar?: string } | null = null;
let posts: WPPost[] = [];
let totalPages = 1;
let error: string | null = null;

try {
    const { getAuthorBySlug, getPostsByAuthor } = await import("../../../lib/api/endpoints");
    const wpAuthor = await getAuthorBySlug(slug);

    if (wpAuthor) {
        author = {
            id: wpAuthor.id,
            name: wpAuthor.name,
            slug: wpAuthor.slug,
            description: wpAuthor.description,
            avatar: wpAuthor.avatar_urls?.["96"] || wpAuthor.avatar_urls?.["48"],
        };

        const response = await getPostsByAuthor(wpAuthor.id, 1, 12);
        posts = response.posts;
        totalPages = response.totalPages;
    }
} catch (e) {
    console.error("Failed to fetch author:", e);
    error = "Menggunakan data contoh";
}

// If no author found from API, create from slug
if (!author) {
    author = {
        id: 0,
        name: slugToName(slug),
        slug: slug,
        description: undefined,
        avatar: undefined,
    };

    // Mock posts
    posts = [
        {
            id: 1,
            slug: "tips-ielts",
            title: "Tips IELTS",
            content: "",
            excerpt: "<p>Tips IELTS</p>",
            date: "2026-02-05T10:00:00",
            featuredImage: { src: "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=800&h=500&fit=crop", alt: "IELTS" },
            author: { name: author.name },
            categories: [{ name: "IELTS", slug: "ielts" }],
        },
        {
            id: 2,
            slug: "beasiswa-tips",
            title: "Tips Beasiswa",
            content: "",
            excerpt: "<p>Tips beasiswa</p>",
            date: "2026-02-03T14:30:00",
            featuredImage: { src: "https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&h=500&fit=crop", alt: "Beasiswa" },
            author: { name: author.name },
            categories: [{ name: "Beasiswa", slug: "beasiswa" }],
        },
    ];
    totalPages = 1;
}

const canonicalUrl = `${Astro.url.origin}/artikel/author/${author.slug}`;

// SEO Structured Data
const structuredData = {
    "@context": "https://schema.org",
    "@type": "ProfilePage",
    mainEntity: {
        "@type": "Person",
        name: author.name,
        url: canonicalUrl,
        description: author.description,
        worksFor: {
            "@type": "Organization",
            name: "Ultimate Education",
        },
    },
};

const breadcrumbData = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        { "@type": "ListItem", position: 1, name: "Home", item: Astro.url.origin },
        { "@type": "ListItem", position: 2, name: "Artikel", item: `${Astro.url.origin}/artikel` },
        { "@type": "ListItem", position: 3, name: author.name, item: canonicalUrl },
    ],
};
---

<Layout title={`Artikel oleh ${author.name} | Blog Ultimate Education`} description={`Baca semua artikel yang ditulis oleh ${author.name} di blog Ultimate Education.`}>
    <Fragment slot="head">
        <link rel="canonical" href={canonicalUrl} />
        <meta property="og:type" content="profile" />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:title" content={`Artikel oleh ${author.name}`} />
        <meta property="profile:username" content={author.slug} />
        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
        <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />
    </Fragment>

    <div class="bg-slate-50 min-h-screen">
        <main class="max-w-7xl mx-auto px-4 md:px-6 xl:px-0">
            <!-- Breadcrumb -->
            <nav class="pt-6 pb-4" aria-label="Breadcrumb">
                <ol class="flex items-center gap-2 text-sm text-slate-500">
                    <li><a href="/" class="hover:text-primary transition-colors">Home</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li><a href="/artikel" class="hover:text-primary transition-colors">Artikel</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li class="text-slate-400">{author.name}</li>
                </ol>
            </nav>

            <!-- Author Header -->
            <div class="pt-4 pb-8">
                <div class="flex items-center gap-5">
                    {
                        author.avatar ? (
                            <img src={author.avatar} alt={`Foto ${author.name}`} class="w-20 h-20 rounded-full object-cover" loading="eager" />
                        ) : (
                            <div class="w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                                <span class="text-primary font-semibold text-3xl">{author.name.charAt(0)}</span>
                            </div>
                        )
                    }
                    <div>
                        <div class="text-sm text-slate-500 mb-1">Penulis</div>
                        <h1 class="text-2xl lg:text-3xl font-semibold font-heading text-gray-900">{author.name}</h1>
                        {author.description && <p class="text-slate-500 mt-1 max-w-lg" set:html={author.description} />}
                        <p class="text-slate-500 mt-2 text-base">{posts.length} artikel</p>
                    </div>
                </div>
            </div>

            {error && <div class="mb-6 px-4 py-3 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl text-base">⚠️ {error}</div>}

            <!-- Articles Grid -->
            <section class="pb-12">
                <h2 class="text-xl font-semibold font-heading text-gray-900 mb-6">Artikel oleh {author.name}</h2>

                {
                    posts.length > 0 ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                            {posts.map((post) => (
                                <ArticleCard post={post} />
                            ))}
                        </div>
                    ) : (
                        <div class="text-center py-12 bg-white rounded-2xl">
                            <p class="text-slate-500">Belum ada artikel dari penulis ini.</p>
                        </div>
                    )
                }

                <Pagination currentPage={1} totalPages={totalPages} baseUrl={`/artikel/author/${author.slug}`} rootUrl={`/artikel/author/${author.slug}`} />
            </section>

            <!-- Back to Blog -->
            <div class="pb-12 text-center">
                <a href="/artikel" class="inline-flex items-center gap-2 text-primary font-medium hover:underline">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Kembali ke Blog
                </a>
            </div>
        </main>
    </div>
</Layout>
