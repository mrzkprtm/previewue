---
/**
 * OWNER: DYNAMIC (Dev B)
 * Author archive page with pagination.
 * SSR mode for dynamic routing.
 */
import Layout from "../../../../layouts/Layout.astro";
import ArticleCard from "../../../../components/blog/ArticleCard.astro";
import Pagination from "../../../../components/blog/Pagination.astro";
import type { WPPost, WPAuthor } from "../../../../types/wp";

// SSR for dynamic routing
export const prerender = false;

const { slug, page } = Astro.params;
const currentPage = parseInt(page || "1");
const postsPerPage = 9;

if (currentPage < 2) {
    return Astro.redirect(`/artikel/author/${slug}`);
}

// Convert slug to display name
function slugToName(s: string): string {
    return s
        .split("-")
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(" ");
}

let author: { id: number; name: string; slug: string; description?: string; avatar?: string } | null = null;
let posts: WPPost[] = [];
let totalPages = 1;
let error: string | null = null;

try {
    const { getAuthorBySlug, getPostsByAuthor } = await import("../../../../lib/api/endpoints");
    const wpAuthor = await getAuthorBySlug(slug);

    if (wpAuthor) {
        author = {
            id: wpAuthor.id,
            name: wpAuthor.name,
            slug: wpAuthor.slug,
            description: wpAuthor.description,
            avatar: wpAuthor.avatar_urls?.["96"] || wpAuthor.avatar_urls?.["48"],
        };

        const response = await getPostsByAuthor(wpAuthor.id, currentPage, postsPerPage);
        posts = response.posts;
        totalPages = response.totalPages;
    }
} catch (e) {
    console.error("Failed to fetch author:", e);
    error = "Menggunakan data contoh";
    if (slug) {
        author = {
            id: 0,
            name: slugToName(slug),
            slug: slug,
            description: undefined,
            avatar: undefined,
        };
        posts = [];
        totalPages = 1;
    }
}

if (!author) {
    return Astro.redirect("/artikel");
}

const canonicalUrl = `${Astro.url.origin}/artikel/author/${author.slug}/${currentPage}`;
const rootUrl = `/artikel/author/${author.slug}`;

// SEO Structured Data
const structuredData = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: `Artikel oleh ${author.name} - Halaman ${currentPage} - Ultimate Education`,
    description: `Halaman ${currentPage} - Kumpulan artikel yang ditulis oleh ${author.name}.`,
    url: canonicalUrl,
    mainEntity: {
        "@type": "ItemList",
        itemListElement: posts.map((post, index) => ({
            "@type": "ListItem",
            position: index + 1,
            url: `${Astro.url.origin}/artikel/${post.slug}`,
        })),
    },
};

const breadcrumbData = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        { "@type": "ListItem", position: 1, name: "Home", item: Astro.url.origin },
        { "@type": "ListItem", position: 2, name: "Artikel", item: `${Astro.url.origin}/artikel` },
        { "@type": "ListItem", position: 3, name: author.name, item: `${Astro.url.origin}${rootUrl}` },
        { "@type": "ListItem", position: 4, name: `Halaman ${currentPage}`, item: canonicalUrl },
    ],
};
---

<Layout title={`Artikel oleh ${author.name} - Halaman ${currentPage} | Blog Ultimate Education`} description={`Halaman ${currentPage} - Baca semua artikel yang ditulis oleh ${author.name} di blog Ultimate Education.`}>
    <Fragment slot="head">
        <link rel="canonical" href={canonicalUrl} />
        <meta name="robots" content="noindex, follow" />
        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
        <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />
    </Fragment>

    <div class="bg-slate-50 min-h-screen">
        <main class="max-w-7xl mx-auto px-4 md:px-6 xl:px-0">
            <!-- Breadcrumb -->
            <nav class="pt-6 pb-4" aria-label="Breadcrumb">
                <ol class="flex items-center gap-2 text-sm text-slate-500">
                    <li><a href="/" class="hover:text-primary transition-colors">Home</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li><a href="/artikel" class="hover:text-primary transition-colors">Artikel</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li><a href={rootUrl} class="hover:text-primary transition-colors">{author.name}</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li class="text-slate-400">Halaman {currentPage}</li>
                </ol>
            </nav>

            <!-- Author Header -->
            <div class="pt-4 pb-8">
                <div class="flex items-center gap-5">
                    {
                        author.avatar ? (
                            <img src={author.avatar} alt={`Foto ${author.name}`} class="w-16 h-16 rounded-full object-cover" loading="eager" />
                        ) : (
                            <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                                <span class="text-primary font-semibold text-2xl">{author.name.charAt(0)}</span>
                            </div>
                        )
                    }
                    <div>
                        <div class="text-sm text-slate-500 mb-1">Penulis</div>
                        <h1 class="text-2xl font-semibold font-heading text-gray-900">{author.name}</h1>
                        <p class="text-slate-500 text-sm">Halaman {currentPage}</p>
                    </div>
                </div>
            </div>

            {error && <div class="mb-6 px-4 py-3 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl text-base">⚠️ {error}</div>}

            <!-- Articles Grid -->
            <section class="pb-12">
                {
                    posts.length > 0 ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                            {posts.map((post) => (
                                <ArticleCard post={post} />
                            ))}
                        </div>
                    ) : (
                        <div class="text-center py-12 bg-white rounded-2xl">
                            <p class="text-slate-500">Tidak ada artikel di halaman ini.</p>
                            <a href={rootUrl} class="mt-4 inline-block text-primary font-medium hover:underline">
                                ← Kembali ke Profil Penulis
                            </a>
                        </div>
                    )
                }

                <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={rootUrl} rootUrl={rootUrl} />
            </section>
        </main>
    </div>
</Layout>
