---
/**
 * OWNER: DYNAMIC (Dev B)
 * Category archive page with SEO optimization.
 * SSR mode for dynamic routing.
 */
import Layout from "../../../layouts/Layout.astro";
import ArticleCard from "../../../components/blog/ArticleCard.astro";
import Pagination from "../../../components/blog/Pagination.astro";
import type { WPPost, WPCategory } from "../../../types/wp";

// SSR for dynamic routing
export const prerender = false;

const { slug } = Astro.params;

let category: WPCategory | null = null;
let posts: WPPost[] = [];
let totalPages = 1;
let error: string | null = null;

try {
    const { getCategories, getPostsByCategory } = await import("../../../lib/api/endpoints");
    const categories = await getCategories();
    category = categories.find((c) => c.slug === slug) || null;

    if (category) {
        const response = await getPostsByCategory(slug!, 1, 9);
        posts = response.posts;
        totalPages = response.totalPages;
    }
} catch (e) {
    console.error("Failed to fetch category:", e);
    error = "Menggunakan data contoh";

    const mockCategories: Record<string, WPCategory> = {
        ielts: { id: 1, name: "IELTS", slug: "ielts", count: 5 },
        beasiswa: { id: 2, name: "Beasiswa", slug: "beasiswa", count: 8 },
        toefl: { id: 3, name: "TOEFL", slug: "toefl", count: 3 },
    };

    category = mockCategories[slug!] || { id: 0, name: slug!, slug: slug!, count: 0 };

    posts = [
        {
            id: 1,
            slug: "tips-ielts",
            title: `Tips ${category.name}`,
            content: "",
            excerpt: `<p>Tips untuk ${category.name}</p>`,
            date: "2026-02-05T10:00:00",
            featuredImage: { src: "https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=800&h=500&fit=crop", alt: category.name },
            author: { name: "Admin" },
            categories: [{ name: category.name, slug: category.slug }],
        },
        {
            id: 2,
            slug: "panduan-lengkap",
            title: `Panduan Lengkap ${category.name}`,
            content: "",
            excerpt: `<p>Panduan ${category.name}</p>`,
            date: "2026-02-03T14:30:00",
            featuredImage: { src: "https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&h=500&fit=crop", alt: category.name },
            author: { name: "Tim" },
            categories: [{ name: category.name, slug: category.slug }],
        },
    ];
    totalPages = 1;
}

if (!category) {
    return Astro.redirect("/artikel");
}

const canonicalUrl = `${Astro.url.origin}/artikel/category/${category.slug}`;

// SEO Structured Data
const structuredData = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: `Artikel ${category.name} - Ultimate Education`,
    description: `Kumpulan artikel tentang ${category.name}: tips, panduan, dan informasi terbaru.`,
    url: canonicalUrl,
    mainEntity: {
        "@type": "ItemList",
        itemListElement: posts.map((post, index) => ({
            "@type": "ListItem",
            position: index + 1,
            url: `${Astro.url.origin}/artikel/${post.slug}`,
        })),
    },
};

const breadcrumbData = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        { "@type": "ListItem", position: 1, name: "Home", item: Astro.url.origin },
        { "@type": "ListItem", position: 2, name: "Artikel", item: `${Astro.url.origin}/artikel` },
        { "@type": "ListItem", position: 3, name: category.name, item: canonicalUrl },
    ],
};
---

<Layout title={`Artikel ${category.name} | Blog Ultimate Education`} description={`Kumpulan artikel tentang ${category.name}: tips, panduan, strategi, dan informasi terbaru dari Ultimate Education.`}>
    <Fragment slot="head">
        <link rel="canonical" href={canonicalUrl} />
        <meta property="og:type" content="website" />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:title" content={`Artikel ${category.name} | Ultimate Education`} />
        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
        <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />
    </Fragment>

    <div class="bg-slate-50 min-h-screen">
        <main class="max-w-7xl mx-auto px-4 md:px-6 xl:px-0">
            <!-- Breadcrumb -->
            <nav class="pt-6 pb-4" aria-label="Breadcrumb">
                <ol class="flex items-center gap-2 text-sm text-slate-500">
                    <li><a href="/" class="hover:text-primary transition-colors">Home</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li><a href="/artikel" class="hover:text-primary transition-colors">Artikel</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li class="text-slate-400">{category.name}</li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="pt-4 pb-8">
                <div class="inline-block bg-primary/10 text-primary px-4 py-1.5 rounded-full text-xs md:text-sm font-semibold mb-4">Kategori</div>
                <h1 class="text-3xl lg:text-4xl font-semibold font-heading text-gray-900 mb-2">{category.name}</h1>
                <p class="text-slate-500">{category.count} artikel dalam kategori ini</p>
            </div>

            {error && <div class="mb-6 px-4 py-3 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl text-base">⚠️ {error}</div>}

            <!-- Articles Grid -->
            <section class="pb-12">
                {
                    posts.length > 0 ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                            {posts.map((post) => (
                                <ArticleCard post={post} />
                            ))}
                        </div>
                    ) : (
                        <div class="text-center py-12 bg-white rounded-2xl">
                            <p class="text-slate-500">Belum ada artikel dalam kategori ini.</p>
                            <a href="/artikel" class="mt-4 inline-block text-primary font-medium hover:underline">
                                ← Kembali ke Blog
                            </a>
                        </div>
                    )
                }

                <Pagination currentPage={1} totalPages={totalPages} baseUrl={`/artikel/category/${category.slug}`} rootUrl={`/artikel/category/${category.slug}`} />
            </section>

            <!-- Back to Blog -->
            <div class="pb-12 text-center">
                <a href="/artikel" class="inline-flex items-center gap-2 text-primary font-medium hover:underline">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Lihat Semua Artikel
                </a>
            </div>
        </main>
    </div>
</Layout>
