---
/**
 * OWNER: DYNAMIC (Dev B)
 * Category archive page with pagination.
 * SSR mode for dynamic routing.
 */
import Layout from "../../../../layouts/Layout.astro";
import ArticleCard from "../../../../components/blog/ArticleCard.astro";
import Pagination from "../../../../components/blog/Pagination.astro";
import type { WPPost, WPCategory } from "../../../../types/wp";

// SSR for dynamic routing
export const prerender = false;

const { slug, page } = Astro.params;
const currentPage = parseInt(page || "1");
const postsPerPage = 9;

if (currentPage < 2) {
    return Astro.redirect(`/artikel/category/${slug}`);
}

let category: WPCategory | null = null;
let posts: WPPost[] = [];
let totalPages = 1;
let error: string | null = null;

try {
    const { getCategories, getPostsByCategory } = await import("../../../../lib/api/endpoints");
    const categories = await getCategories();
    category = categories.find((c) => c.slug === slug) || null;

    if (category) {
        const response = await getPostsByCategory(slug!, currentPage, postsPerPage);
        posts = response.posts;
        totalPages = response.totalPages;
    }
} catch (e) {
    console.error("Failed to fetch category:", e);
    error = "Menggunakan data contoh";

    // Fallback/Mock logic (simplified for file creation)
    if (slug) {
        category = { id: 0, name: slug.charAt(0).toUpperCase() + slug.slice(1), slug: slug, count: 0 };
        posts = [];
        totalPages = 1;
    }
}

if (!category) {
    return Astro.redirect("/artikel");
}

const canonicalUrl = `${Astro.url.origin}/artikel/category/${category.slug}/${currentPage}`;
const rootUrl = `/artikel/category/${category.slug}`;

// SEO Structured Data
const structuredData = {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    name: `Artikel ${category.name} - Halaman ${currentPage} - Ultimate Education`,
    description: `Halaman ${currentPage} - Kumpulan artikel tentang ${category.name}.`,
    url: canonicalUrl,
    mainEntity: {
        "@type": "ItemList",
        itemListElement: posts.map((post, index) => ({
            "@type": "ListItem",
            position: index + 1,
            url: `${Astro.url.origin}/artikel/${post.slug}`,
        })),
    },
};

const breadcrumbData = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: [
        { "@type": "ListItem", position: 1, name: "Home", item: Astro.url.origin },
        { "@type": "ListItem", position: 2, name: "Artikel", item: `${Astro.url.origin}/artikel` },
        { "@type": "ListItem", position: 3, name: category.name, item: `${Astro.url.origin}${rootUrl}` },
        { "@type": "ListItem", position: 4, name: `Halaman ${currentPage}`, item: canonicalUrl },
    ],
};
---

<Layout
    title={`Artikel ${category.name} - Halaman ${currentPage} | Blog Ultimate Education`}
    description={`Halaman ${currentPage} - Kumpulan artikel tentang ${category.name}: tips, panduan, strategi, dan informasi terbaru dari Ultimate Education.`}
>
    <Fragment slot="head">
        <link rel="canonical" href={canonicalUrl} />
        <meta name="robots" content="noindex, follow" />
        <script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
        <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />
    </Fragment>

    <div class="bg-slate-50 min-h-screen">
        <main class="max-w-7xl mx-auto px-4 md:px-6 xl:px-0">
            <!-- Breadcrumb -->
            <nav class="pt-6 pb-4" aria-label="Breadcrumb">
                <ol class="flex items-center gap-2 text-sm text-slate-500">
                    <li><a href="/" class="hover:text-primary transition-colors">Home</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li><a href="/artikel" class="hover:text-primary transition-colors">Artikel</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li><a href={rootUrl} class="hover:text-primary transition-colors">{category.name}</a></li>
                    <li><span class="mx-1">/</span></li>
                    <li class="text-slate-400">Halaman {currentPage}</li>
                </ol>
            </nav>

            <!-- Header -->
            <div class="pt-4 pb-8">
                <div class="inline-block bg-primary/10 text-primary px-4 py-1.5 rounded-full text-xs md:text-sm font-semibold mb-4">Kategori</div>
                <h1 class="text-3xl lg:text-4xl font-semibold font-heading text-gray-900 mb-2">{category.name}</h1>
                <p class="text-slate-500">Halaman {currentPage}</p>
            </div>

            {error && <div class="mb-6 px-4 py-3 bg-amber-50 border border-amber-200 text-amber-800 rounded-xl text-base">⚠️ {error}</div>}

            <!-- Articles Grid -->
            <section class="pb-12">
                {
                    posts.length > 0 ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                            {posts.map((post) => (
                                <ArticleCard post={post} />
                            ))}
                        </div>
                    ) : (
                        <div class="text-center py-12 bg-white rounded-2xl">
                            <p class="text-slate-500">Tidak ada artikel di halaman ini.</p>
                            <a href={rootUrl} class="mt-4 inline-block text-primary font-medium hover:underline">
                                ← Kembali ke Kategori
                            </a>
                        </div>
                    )
                }

                <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={rootUrl} rootUrl={rootUrl} />
            </section>
        </main>
    </div>
</Layout>
