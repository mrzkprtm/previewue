---
const { program } = Astro.props;

import { parsePricingCSV, mapProgramToTabs } from "../../api/csvPricing";

let pricingData = {};
let tabs = ["Group Class", "Private Class", "Custom Class", "Bundling Class"];
try {
    const allRows = parsePricingCSV();
    // Use program.slug for lookup, fallback to name
    let row = allRows.find(r => r.program && r.program.toLowerCase() === program.slug?.toLowerCase());
    if (!row) row = allRows.find(r => r.program && r.program.toLowerCase() === program.name?.toLowerCase());
    if (row) pricingData = mapProgramToTabs(row);
} catch (e) {
    pricingData = {};
}
---

<div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden" x-data="{ activeTab: 'Group Class' }">
    <!-- Tabs Header -->
    <div class="flex overflow-x-auto border-b border-slate-100 scrollbar-hide">
        {tabs.map((tab) => (
            <button
                @click={`activeTab = '${tab}'; $dispatch('tab-change', '${tab}')`}
                class="px-6 py-4 font-semibold text-sm whitespace-nowrap transition-colors relative"
                :class={`activeTab === '${tab}' ? 'text-ultimate-blue bg-blue-50/50' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-50'`}
            >
                {tab}
                <div 
                    class="absolute bottom-0 left-0 w-full h-1 bg-ultimate-blue rounded-t-full transform transition-transform duration-300"
                    :class={`activeTab === '${tab}' ? 'scale-x-100' : 'scale-x-0'`}
                ></div>
            </button>
        ))}
    </div>

    <!-- Tab Content -->
    <div class="p-6 md:p-8">
        {tabs.map((tab) => (
            <div x-show={`activeTab === '${tab}'`} x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 translate-y-2" x-transition:enter-end="opacity-100 translate-y-0" style="display: none;">
                <div class="mb-8">
                    <h3 class="text-xl font-semibold text-ultimate-navy mb-3">{tab}</h3>
                    <p class="text-slate-600 leading-relaxed">{pricingData[tab]?.desc || 'Data tidak tersedia untuk tab ini.'}</p>
                    {tab === 'Bundling Class' && (
                        <div class="mt-2 text-xs md:text-sm font-semibold text-ultimate-blue">
                            Harga Bundling: {pricingData[tab]?.price || 'Tidak tersedia'}
                        </div>
                    )}
                    {tab === 'Group Class' && pricingData[tab]?.tiers && (
                        <div class="mt-6">
                            <form id="group-class-form" class="space-y-4">
                                <div>
                                    <label class="block font-semibold mb-2">Pilih Paket:</label>
                                    <div class="flex gap-4">
                                        {pricingData[tab].tiers.map((tier, idx) => (
                                            <label class="flex items-center gap-2 cursor-pointer" key={tier.name}>
                                                <input type="radio" name="group-tier" value={tier.price} defaultChecked={idx===0} />
                                                <span class="font-semibold">{tier.name}</span>
                                                <span class="text-ultimate-blue font-semibold">Rp {Number(tier.price).toLocaleString('id-ID')}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                {pricingData[tab]?.options?.find(opt => opt.name === 'Per Sesi')?.price && (
                                    <div>
                                        <label class="block font-semibold mb-2">Tambah Kelas (per sesi):</label>
                                        <input type="number" min="0" defaultValue="0" class="border rounded px-3 py-1 w-24" id="group-extra-session" />
                                        <span class="ml-2 text-slate-500">Rp {Number(pricingData[tab].options.find(opt => opt.name === 'Per Sesi').price).toLocaleString('id-ID')} / sesi</span>
                                    </div>
                                )}
                                {pricingData['Bundling Class']?.price && pricingData['Bundling Class'].price !== 'Tidak tersedia' && (
                                    <div>
                                        <label class="block font-semibold mb-2">Bundling Test (opsional):</label>
                                        <input type="checkbox" id="group-bundling-check" />
                                        <span class="ml-2">{pricingData['Bundling Class'].price}</span>
                                    </div>
                                )}
                                <div class="mt-4">
                                    <label class="block font-semibold mb-2">Total:</label>
                                    <span id="group-total" class="text-2xl font-semibold text-ultimate-blue">Rp 0</span>
                                </div>
                            </form>
                            <script type="text/javascript">
                                // Simple client-side calculation for demo (Astro hydration or Alpine/React recommended for production)
                                document.addEventListener('DOMContentLoaded', function() {
                                    const form = document.getElementById('group-class-form');
                                    if (!form) return;
                                    const tierRadios = form.querySelectorAll('input[name="group-tier"]');
                                    const extraInput = form.querySelector('#group-extra-session');
                                    const bundlingCheck = form.querySelector('#group-bundling-check');
                                    const totalSpan = form.querySelector('#group-total');
                                    function calcTotal() {
                                        let base = 0;
                                        tierRadios.forEach(r => { if (r.checked) base = Number(r.value)||0; });
                                        let extra = 0;
                                        if (extraInput) {
                                            const perSesi = Number({JSON.stringify(pricingData[tab]?.options?.find(opt => opt.name === 'Per Sesi')?.price||0)});
                                            extra = (Number(extraInput.value)||0) * perSesi;
                                        }
                                        let bundling = 0;
                                        if (bundlingCheck && bundlingCheck.checked) {
                                            const bundVal = '{pricingData['Bundling Class']?.price}';
                                            if (!isNaN(Number(bundVal.replace(/[^\d]/g, '')))) bundling = Number(bundVal.replace(/[^\d]/g, ''));
                                        }
                                        const total = base + extra + bundling;
                                        totalSpan.textContent = 'Rp ' + total.toLocaleString('id-ID');
                                    }
                                    tierRadios.forEach(r => r.addEventListener('change', calcTotal));
                                    if (extraInput) extraInput.addEventListener('input', calcTotal);
                                    if (bundlingCheck) bundlingCheck.addEventListener('change', calcTotal);
                                    calcTotal();
                                });
                            </script>
                        </div>
                    )}
                </div>
                <!-- Learning Flow Accordion (tetap tampil) -->
                <div class="space-y-4">
                    <h4 class="font-semibold text-slate-800 text-xs md:text-sm uppercase tracking-wider mb-4 border-b border-slate-100 pb-2">Alur Pembelajaran</h4>
                    <div class="space-y-3">
                         <details class="group bg-slate-50 rounded-xl p-4 [&_summary::-webkit-details-marker]:hidden open:bg-white open:shadow-sm open:ring-1 open:ring-slate-100 transition-all">
                            <summary class="flex cursor-pointer items-center justify-between gap-1.5 text-ultimate-navy font-semibold text-sm select-none">
                                <span>Minggu 1-2: Fundamental & Concept</span>
                                <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <p class="mt-3 text-sm text-slate-600 leading-relaxed">Pengenalan format tes, strategi dasar, dan penguatan grammar/vocabulary yang relevan.</p>
                        </details>
                         <details class="group bg-slate-50 rounded-xl p-4 [&_summary::-webkit-details-marker]:hidden open:bg-white open:shadow-sm open:ring-1 open:ring-slate-100 transition-all">
                            <summary class="flex cursor-pointer items-center justify-between gap-1.5 text-ultimate-navy font-semibold text-sm select-none">
                                <span>Minggu 3-4: Skill Building & Practice</span>
                                <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <p class="mt-3 text-sm text-slate-600 leading-relaxed">Latihan intensif per skill (Reading, Listening, Writing, Speaking) dengan bedah soal.</p>
                        </details>
                         <details class="group bg-slate-50 rounded-xl p-4 [&_summary::-webkit-details-marker]:hidden open:bg-white open:shadow-sm open:ring-1 open:ring-slate-100 transition-all">
                            <summary class="flex cursor-pointer items-center justify-between gap-1.5 text-ultimate-navy font-semibold text-sm select-none">
                                <span>Minggu 5: Scoring & Feedback</span>
                                <svg class="w-5 h-5 text-slate-400 group-open:rotate-180 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <p class="mt-3 text-sm text-slate-600 leading-relaxed">Full mock test simulation dan personal feedback session untuk evaluasi akhir.</p>
                        </details>
                    </div>
                </div>
            </div>
        ))}
    </div>
</div>

<script define:vars={{ pricingData }}>
    // Expose data to window for the sidebar to access
    window.programPricingData = pricingData;
</script>
