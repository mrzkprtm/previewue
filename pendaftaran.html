<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self' data:; connect-src 'self' https://rbivamtmcadfnemqcvac.supabase.co https://www.emsifa.com https://cdn.jsdelivr.net http://127.0.0.1:3000 ws://127.0.0.1:3001 ws://localhost:3001; upgrade-insecure-requests">
    <title>Form Pendaftaran Siswa - Ultimate Education</title>
    <!-- Tambahkan ini untuk load Supabase bundled -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .form-header {
            background: #ffffff;
            color: #333;
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
        }
        .form-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .form-header p {
            font-size: 14px;
            color: #666;
        }
        .form-body {
            padding: 30px;
        }
        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            align-items: center;
        }
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }
        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: -1;
        }
        .progress-step.active:not(:last-child)::after {
            background: #145DA0;
        }
        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }
        .progress-step.active .progress-circle {
            background: #145DA0;
            color: white;
        }
        .progress-step.completed .progress-circle {
            background: #145DA0;
            color: white;
        }
        .progress-label {
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        .progress-step.active .progress-label {
            color: #145DA0;
            font-weight: 600;
        }
        .form-section {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        .form-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #145DA0;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-row.full {
            grid-template-columns: 1fr;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        label .required {
            color: #e74c3c;
        }
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #145DA0;
            box-shadow: 0 0 0 3px rgba(20, 93, 160, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .checkbox-group,
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .checkbox-item,
        .radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="checkbox"],
        input[type="radio"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
            accent-color: #145DA0;
        }
        .checkbox-item label,
        .radio-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        button {
            padding: 12px 30px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-next,
        .btn-submit {
            background: #145DA0;
            color: white;
            flex: 1;
        }
        .btn-next:hover,
        .btn-submit:hover {
            background: #0f4477;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(20, 93, 160, 0.4);
        }
        .btn-prev {
            background: #ecf0f1;
            color: #333;
            flex: 1;
        }
        .btn-prev:hover {
            background: #bdc3c7;
        }
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #145DA0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden-field {
            display: none;
        }
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .form-header h1 {
                font-size: 18px;
            }
            .form-body {
                padding: 20px;
            }
            .form-actions {
                flex-direction: column;
            }
            .progress-label {
                font-size: 10px;
            }
            .progress-circle {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
        }

        /* Upload dropzone styles */
        .upload-dropzone {
            border: 2px dashed #d0d7df;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
            background: #fbfcfd;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
        }
        .upload-dropzone.dragover {
            border-color: #145DA0;
            background: #f0f6ff;
            box-shadow: 0 6px 20px rgba(20,93,160,0.08);
        }
        .dropzone-inner p { margin: 4px 0; }
        .dropzone-hint { color: #666; font-size: 13px; }
        .link-button {
            background: none; border: none; color: #145DA0; cursor: pointer; font-weight:600; padding:0;
        }
        .file-info { margin-top: 10px; display:flex; justify-content:space-between; align-items:center; }
        .password-wrapper { display:flex; align-items:center; gap:8px; }
        .password-toggle { background: #ecf0f1; border: none; padding:6px 8px; border-radius:6px; cursor:pointer; }
        .password-meter { width: 100%; height: 8px; background: #eee; border-radius: 4px; margin-top:8px; }
        .password-meter-bar { width: 0%; height: 100%; background: linear-gradient(90deg,#e74c3c,#f1c40f,#2ecc71); border-radius: 4px; transition: width 0.2s; }
        .lms-credentials input { padding: 10px; }

        /* WordPress compatibility: force input, select, textarea size and style */
        .container input[type="text"],
        .container input[type="email"],
        .container input[type="tel"],
        .container input[type="date"],
        .container input[type="number"],
        .container input[type="password"],
        .container select,
        .container textarea {
            padding: 12px !important;
            border: 1px solid #ddd !important;
            border-radius: 5px !important;
            font-size: 14px !important;
            font-family: inherit !important;
            box-sizing: border-box !important;
            min-height: 44px !important;
            background: #fff !important;
            color: #222222 !important;
            width: 100% !important;
            line-height: 1.4 !important;
        }
        .container textarea {
            min-height: 100px !important;
        }
        .container label {
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #333 !important;
        }
        .container .form-group {
            margin-bottom: 12px !important;
        }
        .container input[type="file"] {
            min-height: unset !important;
            padding: 0 !important;
        }
        /* WordPress compatibility: force select[multiple] size and style */
        .container select[multiple] {
            min-height: 160px !important; /* 5 row x ~32px */
            height: auto !important;
            padding: 10px !important;
            font-size: 14px !important;
            width: 100% !important;
            box-sizing: border-box !important;
            background: #fff !important;
        }
                /* Language toggle (flag-only) */
                .toggle {
                    position: relative;
                    height: 42px;
                    display: flex;
                    align-items: center;
                    box-sizing: border-box;
                }
                .toggle input[type="checkbox"] {
                    position: absolute;
                    left: 0;
                    top: 0;
                    z-index: 0;
                    width: 100%;
                    height: 100%;
                    cursor: pointer;
                    opacity: 0;
                }
                .toggle label {
                    position: relative;
                    display: flex;
                    justify-content: space-between;
                    height: 100%;
                    align-items: center;
                    box-sizing: border-box;
                    width: 110px;
                    border-radius: 30px;
                    border: 1px solid transparent;
                    background: transparent;
                    overflow: visible;
                    padding: 0 2px;
                }
                .toggle label .flag {
                    width: 42px;
                    height: 42px;
                    display: block;
                    transition: opacity 0.15s ease, transform 0.12s ease;
                    opacity: 0.5; /* default inactive look */
                    cursor: pointer;
                    position: relative;
                    z-index: 2; /* allow hover on flags */
                }
                .toggle label .flag.left { margin-left: 8px; }
                .toggle label .flag.right { margin-left: 0; margin-right: 8px; }
                /* Active/inactive states based on checkbox (unchecked = id active) */
                .toggle input[type="checkbox"]:not(:checked) + label .flag.left { opacity: 1; }
                .toggle input[type="checkbox"]:not(:checked) + label .flag.right { opacity: 0.5; }
                .toggle input[type="checkbox"]:checked + label .flag.left { opacity: 0.5; }
                .toggle input[type="checkbox"]:checked + label .flag.right { opacity: 1; }
                /* Hover: whichever flag hovered becomes full opacity */
                .toggle label .flag:hover { opacity: 1; transform: scale(1.06); }

                /* Toast notifications */
                #toast-container {
                    position: fixed;
                    top: 16px;
                    right: 16px;
                    z-index: 99999;
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    pointer-events: none;
                }
                .toast {
                    min-width: 220px;
                    max-width: 420px;
                    color: #fff;
                    background: rgba(0,0,0,0.85);
                    padding: 10px 12px;
                    border-radius: 8px;
                    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 8px;
                    pointer-events: auto;
                    transform: translateY(-6px);
                    opacity: 0;
                    transition: transform 160ms ease, opacity 160ms ease;
                }
                .toast.show { transform: translateY(0); opacity: 1; }
                .toast.error { background: linear-gradient(90deg,#e74c3c,#d6453b); }
                .toast.success { background: linear-gradient(90deg,#27ae60,#2ecc71); }
                .toast .msg { flex: 1; font-size: 14px; line-height: 1.2; }
                .toast .close { background: transparent; border: 0; color: rgba(255,255,255,0.9); font-weight: 700; cursor: pointer; padding: 4px; margin-left: 8px; }
    </style>
</head>
<body data-rsssl=1 data-rsssl=1 data-rsssl=1>
    <div class="container">
        <div class="form-header">
            <!-- Language Toggle (flag switch) -->
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <svg style="display:none;">
                    <symbol id="flag-id" viewBox="0 0 512 512">
                        <g fill-rule="nonzero">
                            <path fill="#4D4D4D" d="M256 0c70.683 0 134.689 28.664 181.013 74.987C483.336 121.311 512 185.316 512 256c0 70.683-28.664 134.689-74.987 181.013C390.689 483.336 326.683 512 256 512c-70.676 0-134.689-28.664-181.013-74.987C28.664 390.689 0 326.676 0 256c0-70.684 28.664-134.689 74.987-181.013C121.311 28.664 185.316 0 256 0z"/>
                            <path fill="#fff" d="M256.001 19.597c65.278 0 124.383 26.465 167.162 69.242 42.777 42.779 69.243 101.885 69.243 167.162 0 65.278-26.466 124.383-69.246 167.159-42.776 42.78-101.881 69.246-167.159 69.246-65.278 0-124.383-26.466-167.162-69.243-42.777-42.779-69.242-101.884-69.242-167.162 0-65.277 26.465-124.383 69.242-167.162 42.779-42.777 101.884-69.242 167.162-69.242z"/>
                            <path fill="#fff" d="M256.001 39.6c119.514 0 216.401 96.887 216.401 216.401 0 119.514-96.887 216.401-216.401 216.401-119.514 0-216.401-96.887-216.401-216.401C39.6 136.487 136.487 39.6 256.001 39.6z"/>
                            <path fill="#CE1126" d="M472.402 256H39.6c.001-119.514 96.887-216.4 216.401-216.4 119.514 0 216.4 96.886 216.401 216.4z"/>
                        </g>
                    </symbol>
                    <symbol id="flag-en" viewBox="0 0 512 512">
                        <g fill-rule="nonzero">
                            <path fill="#999" d="M256 0c70.68 0 134.69 28.66 181.01 74.99C483.34 121.31 512 185.32 512 256c0 70.68-28.66 134.69-74.99 181.01C390.69 483.34 326.68 512 256 512c-70.68 0-134.69-28.66-181.01-74.99C28.66 390.69 0 326.68 0 256c0-70.68 28.66-134.69 74.99-181.01C121.31 28.66 185.32 0 256 0z"/>
                            <path fill="#fff" d="M256 19.48c65.3 0 124.46 26.48 167.25 69.27l1.09 1.18c42.14 42.71 68.18 101.37 68.18 166.06 0 65.31-26.5 124.46-69.29 167.25l-1.18 1.09c-42.73 42.16-101.4 68.19-166.05 68.19-65.23 0-124.37-26.51-167.18-69.33-42.84-42.74-69.33-101.89-69.33-167.2 0-65.31 26.48-124.45 69.27-167.24C131.55 45.96 190.7 19.48 256 19.48z"/>
                            <path fill="#FEFEFE" d="M256 39.59c119.52 0 216.41 96.89 216.41 216.4 0 119.52-96.89 216.42-216.41 216.42-119.51 0-216.4-96.9-216.4-216.42 0-119.51 96.89-216.4 216.4-216.4z"/>
                            <path fill="#012169" d="M183.49 179.55V52.05c-41.32 14.7-76.85 41.61-102.27 76.35l102.27 51.15zm0 152.9v127.5c-41.3-14.7-76.82-41.59-102.26-76.35l102.26-51.15zm144.55 0v127.67c41.45-14.63 77.09-41.54 102.61-76.34l-102.61-51.33zm0-152.9V51.88c41.45 14.63 77.11 41.54 102.62 76.35l-102.62 51.32z"/>
                            <path fill="#C8102E" d="M448.3 328.16h-48.11l49.35 24.72c3.21-6.41 6.11-13 8.69-19.75l-9.93-4.97zm-9.34-187.76-86.42 43.33h48.11l48.95-24.5c-3.23-6.46-6.79-12.75-10.64-18.83zM212.41 299.26v168.75c14.08 2.87 28.66 4.4 43.59 4.4 14.76 0 29.19-1.49 43.13-4.3V299.26h168.94c2.83-13.98 4.34-28.44 4.34-43.27 0-14.88-1.51-29.42-4.37-43.47H299.13V43.9A217.404 217.404 0 0 0 256 39.59c-14.93 0-29.51 1.54-43.59 4.4v168.53H43.97a217.777 217.777 0 0 0-4.37 43.47c0 14.83 1.51 29.29 4.34 43.27h168.47zM63.12 183.84h48.11l-48.89-24.48c-3.2 6.41-6.11 13.02-8.68 19.76l9.46 4.72zm95.87 144.43h-48.11l-48.57 24.31A216.76 216.76 0 0 0 73 371.52l86.43-43.25h-.44z"/>
                        </g>
                    </symbol>
                </svg>
                <div class="toggle" style="align-items:center;">
                    <input id="lang-switch" type="checkbox" />
                    <label for="lang-switch">
                        <svg class="flag left" viewBox="0 0 512 512" aria-hidden="true"><use href="#flag-id"></use></svg>
                        <svg class="flag right" viewBox="0 0 512 512" aria-hidden="true"><use href="#flag-en"></use></svg>
                    </label>
                </div>
            </div>
            <h1 id="form-title">Formulir Pendaftaran</h1>
        </div>
        <div class="form-body">
            <div class="progress-bar">
                <div class="progress-step active" data-step="1">
                    <div class="progress-circle">1</div>
                    <div class="progress-label">Dasar</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-circle">2</div>
                    <div class="progress-label">Pekerjaan</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-circle">3</div>
                    <div class="progress-label">Tujuan</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-circle">4</div>
                    <div class="progress-label">Studi/Kerja</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="progress-circle">5</div>
                    <div class="progress-label">Preferensi</div>
                </div>
                <div class="progress-step" data-step="6">
                    <div class="progress-circle">6</div>
                    <div class="progress-label">Pembayaran</div>
                </div>
            </div>
            <div class="message" id="message"></div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Menyimpan data...</p>
            </div>
            <form id="studentForm">
                <!-- SECTION 1: INFORMASI DASAR SISWA -->
                <div class="form-section active" data-section="1">
                    <h2 class="section-title">Informasi Dasar</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-nama">Nama Lengkap <span class="required">*</span></label>
                            <input id="input-nama" type="text" name="nama" required>
                        </div>
                        <div class="form-group">
                            <label id="label-email">Email Aktif <span class="required">*</span></label>
                            <input id="input-email" type="email" name="email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-nohp">No. WhatsApp <span class="required">*</span></label>
                            <input id="input-nohp" type="tel" name="no_hp" placeholder="628xxxxxxxxxx" required>
                        </div>
                        <div class="form-group">
                            <label id="label-jk">Jenis Kelamin <span class="required">*</span></label>
                            <select id="jenis_kelamin" name="jenis_kelamin" required>
                                <option value="">-- Pilih --</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-negara">Negara <span class="required">*</span></label>
                            <select name="negara" id="negara_select" required>
                                <option value="Indonesia" selected>Indonesia</option>
                                <option value="United States">United States</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Australia">Australia</option>
                                <option value="Canada">Canada</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Malaysia">Malaysia</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-provinsi">Provinsi <span class="required">*</span></label>
                            <select name="provinsi" id="provinsi_select" required>
                                <option value="">-- Pilih Provinsi --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-kabupaten">Kabupaten/Kota <span class="required">*</span></label>
                            <select name="kota" id="kota_select" required>
                                <option value="">-- Pilih Kabupaten/Kota --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-kecamatan">Kecamatan <span class="required">*</span></label>
                            <select name="kecamatan" id="kecamatan_select" required>
                                <option value="">-- Pilih Kecamatan --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-kelurahan">Kelurahan/Desa <span class="required">*</span></label>
                            <select name="kelurahan" id="kelurahan_select" required>
                                <option value="">-- Pilih Kelurahan/Desa --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-tgllahir">Tanggal Lahir <span class="required">*</span></label>
                            <input id="input-tgllahir" type="date" name="tanggal_lahir" required>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-alamat">Alamat Lengkap <span class="required">*</span></label>
                            <textarea name="alamat" id="alamat_textarea" required placeholder="Jln... No..., RT/RW, dll"></textarea>
                            <small id="alamat_help" style="color: #666; font-size: 12px;">Untuk negara selain Indonesia, tulis alamat lengkap di sini.</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-kontakdarurat">Nama Kontak Darurat <span class="required">*</span></label>
                            <input id="input-kontakdarurat" type="text" name="nama_kontak_darurat" required>
                        </div>
                        <div class="form-group">
                            <label id="label-nokontakdarurat">No. Kontak Darurat <span class="required">*</span></label>
                            <input id="input-nokontakdarurat" type="tel" name="kontak_darurat" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-status">Status Saat Ini <span class="required">*</span></label>
                            <select id="status" name="status" required>
                                <option value="">-- Pilih --</option>
                                <option value="Pelajar SMA">Pelajar SMA</option>
                                <option value="Mahasiswa">Mahasiswa</option>
                                <option value="Fresh Graduate">Fresh Graduate</option>
                                <option value="Bekerja">Bekerja</option>
                                <option value="Tidak Bekerja / Gap Year">Tidak Bekerja / Gap Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-pendidikan">Pendidikan Terakhir <span class="required">*</span></label>
                            <select id="level" name="level" required>
                                <option value="">-- Pilih --</option>
                                <option value="SMA/SMK">SMA/SMK</option>
                                <option value="D3">D3</option>
                                <option value="S1">S1</option>
                                <option value="S2">S2</option>
                                <option value="S3">S3</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- SECTION 2: PEKERJAAN -->
                <div class="form-section" data-section="2">
                    <h2 class="section-title">Informasi Pekerjaan</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-status_kerja">Saat Ini Bekerja? <span class="required">*</span></label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="kerja_ya" name="status_kerja" value="Ya">
                                    <label for="kerja_ya" id="label-kerja_ya">Ya</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="kerja_tidak" name="status_kerja" value="Tidak" checked>
                                    <label for="kerja_tidak" id="label-kerja_tidak">Tidak</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group hidden-field" id="field_perusahaan">
                            <label id="label-perusahaan">Nama Perusahaan/Institusi</label>
                            <input type="text" name="perusahaan" id="input-perusahaan">
                        </div>
                    </div>
                    <div class="form-row hidden-field" id="field_posisi">
                        <div class="form-group">
                            <label id="label-posisi">Posisi/Jabatan</label>
                            <input type="text" name="posisi" id="input-posisi">
                        </div>
                        <div class="form-group">
                            <label id="label-industri">Industri</label>
                            <select name="industri" id="industri_select">
                                <option value="">-- Pilih --</option>
                                <option value="Pendidikan">Pendidikan</option>
                                <option value="Teknologi">Teknologi</option>
                                <option value="Keuangan">Keuangan</option>
                                <option value="Manufaktur">Manufaktur</option>
                                <option value="Healthcare">Healthcare</option>
                                <option value="Government">Government</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- SECTION 3: TUJUAN PROGRAM -->
                <div class="form-section" data-section="3">
                    <h2 class="section-title">Tujuan Program</h2>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-tujuan_utama">Tujuan Utama Mengambil Kursus <span class="required">*</span></label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="tujuan1" name="tujuan" value="Pendidikan (Studi Luar/Dalam Negeri)">
                                    <label for="tujuan1" id="label-tujuan1">Pendidikan (Studi Luar/Dalam Negeri)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="tujuan2" name="tujuan" value="Pekerjaan / Karier">
                                    <label for="tujuan2" id="label-tujuan2">Pekerjaan / Karier</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="tujuan3" name="tujuan" value="Migrasi">
                                    <label for="tujuan3" id="label-tujuan3">Migrasi</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="tujuan4" name="tujuan" value="Pengembangan Diri">
                                    <label for="tujuan4" id="label-tujuan4">Pengembangan Diri</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-jenjang">Jenjang Pendidikan yang Ditargetkan</label>
                            <select name="jenjang_pendidikan" id="jenjang_select">
                                <option value="">-- Pilih --</option>
                                <option value="S1">S1</option>
                                <option value="S2">S2</option>
                                <option value="S3">S3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-program">Program Tes yang Ingin Dipersiapkan <span class="required">*</span></label>
                            <select name="program" id="program_select" required>
                                <option value="">-- Pilih --</option>
                                <option value="IELTS">IELTS</option>
                                <option value="SAT">SAT</option>
                                <option value="GMAT">GMAT</option>
                                <option value="GRE">GRE</option>
                                <option value="TOEFL">TOEFL</option>
                                <option value="TOEFL iBT">TOEFL iBT</option>
                                <option value="PTE">PTE</option>
                                <option value="IGCSE">IGCSE</option>
                                <option value="TOEIC">TOEIC</option>
                                <option value="GED">GED</option>
                                <option value="A-Level">A-Level</option>
                                <option value="AS-Level">AS-Level</option>
                                <option value="O-Level">O-Level</option>
                                <option value="IB">IB</option>
                                <option value="LSAT">LSAT</option>
                                <option value="UTBK">UTBK</option>
                                <option value="Scholarship">Scholarship</option>
                                <option value="Ausbildung">Ausbildung</option>
                                <option value="General English">General English</option>
                                <option value="Business English">Business English</option>
                                <option value="BIPA">BIPA</option>
                                <option value="JLPT">JLPT</option>
                                <option value="HSK">HSK</option>
                                <option value="TOPIK">TOPIK</option>
                                <option value="DELF">DELF</option>
                                <option value="TestDaF">TestDaF</option>
                                <option value="Duolingo">Duolingo</option>
                                <option value="Belum Tahu">Belum Tahu / Butuh Konsultasi</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-tes_tambahan">Butuh Tes Lain Selain Tes Utama?</label>
                            <select name="tes_tambahan" id="tes_tambahan_select">
                                <option value="">-- Pilih --</option>
                                <option value="Ya">Ya</option>
                                <option value="Tidak">Tidak</option>
                                <option value="Belum Yakin">Belum Yakin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label id="label-rencana_tes">Kapan Rencana Mengambil Tes Resmi?</label>
                            <input type="date" name="rencana_tes" id="input-rencana_tes">
                        </div>
                    </div>
                    <div class="form-row hidden-field" id="field_tes_tambahan">
                        <div class="form-group">
                            <label>Pilih Tes Tambahan</label>
                            <select name="tes_tambahan_detail" multiple size="5">
                                <option value="IELTS">IELTS</option>
                                <option value="SAT">SAT</option>
                                <option value="GMAT">GMAT</option>
                                <option value="GRE">GRE</option>
                                <option value="TOEFL">TOEFL</option>
                                <option value="TOEFL iBT">TOEFL iBT</option>
                                <option value="PTE">PTE</option>
                                <option value="IGCSE">IGCSE</option>
                                <option value="TOEIC">TOEIC</option>
                                <option value="GED">GED</option>
                                <option value="A-Level">A-Level</option>
                                <option value="AS-Level">AS-Level</option>
                                <option value="O-Level">O-Level</option>
                                <option value="IB">IB</option>
                                <option value="LSAT">LSAT</option>
                                <option value="UTBK">UTBK</option>
                                <option value="Scholarship">Scholarship</option>
                                <option value="Ausbildung">Ausbildung</option>
                                <option value="General English">General English</option>
                                <option value="Business English">Business English</option>
                                <option value="BIPA">BIPA</option>
                                <option value="JLPT">JLPT</option>
                                <option value="HSK">HSK</option>
                                <option value="TOPIK">TOPIK</option>
                                <option value="DELF">DELF</option>
                                <option value="TestDaF">TestDaF</option>
                                <option value="Duolingo">Duolingo</option>
                            </select>
                            <small style="color: #666; font-size: 12px;">Tekan Ctrl untuk memilih multiple tes</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-target_skor">Target Skor yang Ingin Dicapai</label>
                            <input type="text" name="target_skor" id="input-target_skor" placeholder="Contoh: 7.5 (IELTS), 100 (TOEFL)">
                        </div>
                        <div class="form-group">
                            <label id="label-skor_awal">Skor Awal (jika ada)</label>
                            <input type="number" name="skor_awal" id="input-skor_awal" step="0.1">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-kendala">Kendala Utama Anda Saat Ini</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala1" name="kendala" value="Speaking">
                                    <label for="kendala1" id="label-kendala1">Speaking</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala2" name="kendala" value="Writing">
                                    <label for="kendala2" id="label-kendala2">Writing</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala3" name="kendala" value="Reading">
                                    <label for="kendala3" id="label-kendala3">Reading</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala4" name="kendala" value="Listening">
                                    <label for="kendala4" id="label-kendala4">Listening</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala5" name="kendala" value="Grammar">
                                    <label for="kendala5" id="label-kendala5">Grammar</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala6" name="kendala" value="Konsistensi belajar">
                                    <label for="kendala6" id="label-kendala6">Konsistensi Belajar</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="kendala9" name="kendala" value="Lain lain">
                                    <label for="kendala9" id="label-kendala9">Lain lain</label>
                                </div>
                                <div class="checkbox-item" id="kendala_lain_wrapper" style="margin-left: 20px;">
                                    <input type="text" id="kendala_lain_input" name="kendala" class="hidden-field" disabled placeholder="Jelaskan kendala (opsional)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- SECTION 4: INFO STUDI / PEKERJAAN LANJUTAN -->
                <div class="form-section" data-section="4">
                    <h2 class="section-title">Informasi Studi/Pekerjaan Lanjutan</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-negara_studi">Negara Tujuan Studi</label>
                            <select id="negara_studi_select">
                                <option value="">-- Pilih Negara --</option>
                            </select>
                            <input type="text" id="negara_studi_other" class="hidden-field" placeholder="Masukkan negara lain...">
                            <!-- Hidden input used as the authoritative form field -->
                            <input type="hidden" name="negara_studi" id="negara_studi_input">
                        </div>
                        <div class="form-group">
                            <label id="label-universitas">Universitas Target (jika sudah ada)</label>
                            <select id="universitas_select">
                                <option value="">-- Pilih Universitas --</option>
                            </select>
                            <input type="text" id="universitas_target_other" class="hidden-field" placeholder="Masukkan universitas...">
                            <!-- Hidden input used as the authoritative form field -->
                            <input type="hidden" name="universitas_target" id="universitas_target_input">
                            <small style="color: #666; font-size: 12px;">Pilih dari daftar top 10 universitas di negara yang dipilih, atau pilih <strong>Lainnya (Masukkan sendiri)</strong> untuk mengetik manual.</small>
                        </div>
                    </div> 
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-program_studi">Program Studi Target</label>
                            <input type="text" name="program_studi" id="input-program_studi" placeholder="Contoh: Computer Science, Business">
                        </div>
                        <div class="form-group">
                            <label id="label-intake">Perkiraan Intake</label>
                            <select name="intake" id="intake_select">
                                <option value="">-- Pilih --</option>
                                <option value="Jan–Mar">Januari - Maret</option>
                                <option value="Apr–Jun">April - Juni</option>
                                <option value="Jul–Sep">Juli - September</option>
                                <option value="Oct–Dec">Oktober - Desember</option>
                                <option value="Belum Pasti">Belum Pasti</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-negara_kerja">Negara Tujuan Bekerja</label>
                            <input type="text" name="negara_kerja" id="input-negara_kerja">
                        </div>
                        <div class="form-group">
                            <label id="label-bidang_industri_target">Bidang/Industri Target</label>
                            <input type="text" name="bidang_industri_target" id="input-bidang_industri_target">
                        </div>
                    </div>
                </div>
                <!-- SECTION 5: PREFERENSI KELAS & EKSPEKTASI -->
                <div class="form-section" data-section="5">
                    <h2 class="section-title">Preferensi & Ekspektasi</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-jadwal">Preferensi Kelas <span class="required">*</span></label>
                            <select name="jadwal" id="jadwal_select" required>
                                <option value="">-- Pilih --</option>
                                <option value="Private">Private</option>
                                <option value="Semi-private">Semi-private</option>
                                <option value="Group">Group</option>
                                <option value="Paket">Paket</option>
                            </select>
                        </div>
                        <div class="form-group hidden-field" id="field_program_level">
                            <label id="label-program_level">Tingkat Program <span class="required">*</span></label>
                            <select name="program_level" id="program_level_select" required>
                                <option value="">-- Pilih Kelas Terlebih Dahulu --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-program_intensif">Bersedia Program Intensif? <span class="required">*</span></label>
                            <select name="program_intensif" id="program_intensif_select" required>
                                <option value="">-- Pilih --</option>
                                <option value="Ya">Ya</option>
                                <option value="Tidak">Tidak</option>
                                <option value="Tergantung rekomendasi tutor">Tergantung Rekomendasi Tutor</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-alasan_memilih">Alasan Memilih Ultimate Education</label>
                            <textarea name="alasan_memilih" id="input-alasan_memilih" placeholder="Contoh: Terjangkau, Lokasi, Benefit, etc."></textarea>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-ekspektasi">Ekspektasi Anda Setelah Mengikuti Program Ini</label>
                            <textarea name="ekspektasi" id="input-ekspektasi" placeholder="Tulis harapan Anda..."></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label id="label-advisor">Bersedia Dihubungi Tim Academic Advisor?</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="advisor_ya" name="screening" value="Ya" checked>
                                    <label for="advisor_ya" id="label-advisor_ya">Ya</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="advisor_tidak" name="screening" value="Tidak">
                                    <label for="advisor_tidak" id="label-advisor_tidak">Tidak</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label id="label-kursus_sebelumnya">Pernah Kursus Persiapan Sebelumnya?</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="kursus_ya" name="kursus_sebelumnya" value="Ya">
                                    <label for="kursus_ya" id="label-kursus_ya">Ya</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="kursus_tidak" name="kursus_sebelumnya" value="Tidak" checked>
                                    <label for="kursus_tidak" id="label-kursus_tidak">Tidak</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row full hidden-field" id="field_kursus_sebelumnya">
                        <div class="form-group">
                            <label id="label-kursus_detail">Tes Apa & Skor Terakhir (jika ada)</label>
                            <input type="text" name="kursus_sebelumnya_detail" id="input-kursus_sebelumnya_detail" placeholder="Contoh: IELTS 6.5">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-catatan">Catatan Tambahan</label>
                            <textarea name="catatan" id="input-catatan" placeholder="Informasi lain yang ingin Anda sampaikan..."></textarea>
                        </div>
                    </div>
                </div>
                <!-- SECTION 6: PEMBAYARAN DAN LMS -->
                <div class="form-section" data-section="6">
                    <h2 class="section-title">Pembayaran & Akses LMS</h2>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-bukti_pembayaran">Upload Bukti Pembayaran <span class="required">*</span></label>
                            <div id="dropzone" class="upload-dropzone" aria-label="Upload bukti pembayaran">
                                <input type="file" name="bukti_pembayaran" id="bukti_pembayaran" accept="image/*,.pdf" required hidden>
                                <div class="dropzone-inner" id="dropzone_inner">
                                    <p><strong id="dropzone_strong">Drag & drop di sini</strong> <span id="dropzone_or">atau</span> <button type="button" id="chooseFileBtn" class="link-button">Pilih File</button></p>
                                    <p class="dropzone-hint">Format: JPG, PNG, atau PDF. Maksimal 5MB</p>
                                </div>
                                <div class="file-info" id="bukti_file_info" style="display:none;">
                                    <p id="bukti_file_name"></p>
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <button type="button" id="preview_bukti_btn" class="link-button">Lihat</button>
                                        <button type="button" id="remove_bukti_btn" class="link-button">Hapus</button>
                                    </div>
                                </div>
                                <div class="dropzone-error" id="bukti_error" style="display:none;color:#e74c3c;font-size:13px;margin-top:8px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label id="label-lms_username">Username untuk LMS <span class="required">*</span></label>
                            <input type="text" name="lms_username" id="lms_username" required placeholder="Masukkan username yang diinginkan">
                            <small id="lms_username_help" style="color:#666;font-size:12px;">Username akan digunakan untuk akses LMS</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group lms-credentials">
                            <label id="label-lms_password">Password untuk LMS <span class="required">*</span></label>
                            <div class="password-wrapper">
                                <input type="password" name="lms_password" id="lms_password" required placeholder="Minimal 8 karakter">
                                <button type="button" id="togglePassword" class="password-toggle" aria-label="Tampilkan/ sembunyikan password">Show</button>
                            </div>
                            <div class="password-meter" id="password_meter">
                                <div class="password-meter-bar" id="password_meter_bar"></div>
                            </div>
                            <small id="password_help" style="color:#666;font-size:12px;">Gunakan minimal 8 karakter; kombinasi huruf & angka disarankan.</small>
                        </div>
                        <div class="form-group lms-credentials">
                            <label id="label-lms_password_confirm">Konfirmasi Password LMS <span class="required">*</span></label>
                            <div class="password-wrapper">
                                <input type="password" name="lms_password_confirm" id="lms_password_confirm" required placeholder="Ulangi password">
                                <button type="button" id="togglePasswordConfirm" class="password-toggle" aria-label="Tampilkan/ sembunyikan password konfirmasi">Show</button>
                            </div>
                            <small id="lms_password_confirm_help" style="color:#666;font-size:12px;">Pastikan password konfirmasi sama dengan password di sebelah kiri.</small>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-prev" id="btnPrev" style="display: none;">← Sebelumnya</button>
                    <button type="button" class="btn-next" id="btnNext">Lanjut →</button>
                    <button type="submit" class="btn-submit" id="btnSubmit" style="display: none;">Kirim Pendaftaran</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Toast container for inline notifications -->
    <div id="toast-container" aria-live="polite" aria-atomic="true"></div>
    <script>
                // Multi-language dictionary
                const langDict = {
                    id: {
                        formTitle: 'Formulir Pendaftaran',
                        otherOption: 'Lainnya (Masukkan sendiri)',
                        sectionTitles: [
                            'Informasi Dasar',
                            'Informasi Pekerjaan',
                            'Tujuan Program',
                            'Informasi Studi/Pekerjaan Lanjutan',
                            'Preferensi & Ekspektasi',
                            'Pembayaran & Akses LMS'
                        ],
                        progress: ['Dasar','Pekerjaan','Tujuan','Studi/Kerja','Preferensi','Pembayaran'],
                        btnPrev: '← Sebelumnya',
                        btnNext: 'Lanjut →',
                        btnSubmit: 'Kirim Pendaftaran',
                        alamatHint: 'Untuk negara selain Indonesia, tulis alamat lengkap di sini.',
                        fileHint: 'Format: JPG, PNG, atau PDF. Maksimal 5MB',
                        chooseFile: 'Pilih File',
                        dropzoneText: 'Drag & drop di sini',
                        dropzoneOr: 'atau',
                        fileView: 'Lihat',
                        fileRemove: 'Hapus',
                        dropzoneError: 'File bukti pembayaran wajib diunggah',
                        successSubmission: 'Berhasil! Data Anda telah dikirim. Tim kami akan menghubungi Anda segera.',
                        viewPaymentPDF: 'Lihat Bukti Pembayaran (PDF)',
                        downloadPayment: 'Download Bukti Pembayaran',
                        toast: {
                            fieldRequired: '{field} wajib diisi',
                            passwordMismatch: 'Konfirmasi password tidak sama',
                            passwordTooShort: 'Password LMS minimal 8 karakter',
                            fileRequired: 'Anda harus mengupload bukti pembayaran',
                            validationMissing: '⚠ Harap isi semua field yang wajib diisi',
                            genericError: 'Error: {msg}'
                        },
                        passwordShow: 'Show',
                        passwordHide: 'Hide',
                        passwordHelpWeak: 'Lemah — gunakan minimal 8 karakter dengan kombinasi huruf dan angka.',
                        passwordHelpMedium: 'Sedang — tambahkan simbol atau huruf kapital.',
                        passwordHelpStrong: 'Kuat — baik!',
                        fields: {
                            labels: {
                                'label-nama': 'Nama Lengkap *',
                                'label-email': 'Email Aktif *',
                                'label-nohp': 'No. WhatsApp *',
                                'label-jk': 'Jenis Kelamin *',
                                'label-negara': 'Negara *',
                                'label-provinsi': 'Provinsi *',
                                'label-kabupaten': 'Kabupaten/Kota *',
                                'label-kecamatan': 'Kecamatan *',
                                'label-kelurahan': 'Kelurahan/Desa *',
                                'label-tgllahir': 'Tanggal Lahir *',
                                'label-alamat': 'Alamat Lengkap *',
                                'label-kontakdarurat': 'Nama Kontak Darurat *',
                                'label-nokontakdarurat': 'No. Kontak Darurat *',
                                'label-status': 'Status Saat Ini *',
                                'label-pendidikan': 'Pendidikan Terakhir *',
                                'label-status_kerja': 'Saat Ini Bekerja? *',
                                'label-kerja_ya': 'Ya',
                                'label-kerja_tidak': 'Tidak',
                                'label-perusahaan': 'Nama Perusahaan/Institusi',
                                'label-posisi': 'Posisi/Jabatan',
                                'label-industri': 'Industri',
                                'label-tujuan_utama': 'Tujuan Utama Mengambil Kursus *',
                                'label-tujuan1': 'Pendidikan (Studi Luar/Dalam Negeri)',
                                'label-tujuan2': 'Pekerjaan / Karier',
                                'label-tujuan3': 'Migrasi',
                                'label-tujuan4': 'Pengembangan Diri',
                                'label-jenjang': 'Jenjang Pendidikan yang Ditargetkan',
                                'label-program': 'Program Tes yang Ingin Dipersiapkan *',
                                'label-tes_tambahan': 'Butuh Tes Lain Selain Tes Utama?',
                                'label-rencana_tes': 'Kapan Rencana Mengambil Tes Resmi?',
                                'label-negara_studi': 'Negara Tujuan Studi',
                                'label-universitas': 'Universitas Target (jika sudah ada)',
                                'label-program_studi': 'Program Studi Target',
                                'label-intake': 'Perkiraan Intake',
                                'label-negara_kerja': 'Negara Tujuan Bekerja',
                                'label-bidang_industri_target': 'Bidang/Industri Target',
                                'label-jadwal': 'Preferensi Kelas *',
                                'label-program_level': 'Tingkat Program *',
                                'label-program_intensif': 'Bersedia Program Intensif? *',
                                'label-target_skor': 'Target Skor yang Ingin Dicapai',
                                'label-skor_awal': 'Skor Awal (jika ada)',
                                'label-rencana_tes': 'Kapan Rencana Mengambil Tes Resmi?',
                                'label-kendala': 'Kendala Utama Anda Saat Ini',
                                'label-kendala1': 'Speaking',
                                'label-kendala2': 'Writing',
                                'label-kendala3': 'Reading',
                                'label-kendala4': 'Listening',
                                'label-kendala5': 'Grammar',
                                'label-kendala6': 'Konsistensi Belajar',
                                'label-kendala9': 'Lain lain',
                                'label-bukti_pembayaran': 'Upload Bukti Pembayaran *',
                                'label-alasan_memilih': 'Alasan Memilih Ultimate Education',
                                'label-ekspektasi': 'Ekspektasi Anda Setelah Mengikuti Program Ini',
                                'label-advisor': 'Bersedia Dihubungi Tim Academic Advisor?',
                                'label-advisor_ya': 'Ya',
                                'label-advisor_tidak': 'Tidak',
                                'label-kursus_sebelumnya': 'Pernah Kursus Persiapan Sebelumnya?',
                                'label-kursus_ya': 'Ya',
                                'label-kursus_tidak': 'Tidak',
                                'label-kursus_detail': 'Tes Apa & Skor Terakhir (jika ada)',
                                'label-catatan': 'Catatan Tambahan',
                                'label-lms_username': 'Username untuk LMS *',
                                'label-lms_password': 'Password untuk LMS *',
                                'label-lms_password_confirm': 'Konfirmasi Password LMS *'
                            },
                            placeholders: {
                                'input-nohp': '628xxxxxxxxxx',
                                'input-tgllahir': 'dd/mm/yyyy',
                                'alamat_textarea': 'Jln... No..., RT/RW, dll',
                                'kendala_lain_input': 'Jelaskan kendala (opsional)',
                                'negara_studi_other': 'Masukkan negara lain...',
                                'universitas_target_other': 'Masukkan universitas...',
                                'lms_username': 'Masukkan username yang diinginkan',
                                'lms_password': 'Minimal 8 karakter',
                                'lms_password_confirm': 'Ulangi password',
                                'input-program_studi': 'Contoh: Computer Science, Business',
                                'input-negara_kerja': 'Contoh: Singapore, Australia',
                                'input-bidang_industri_target': 'Contoh: IT, Finance, Education',
                                'input-alasan_memilih': 'Contoh: Terjangkau, Lokasi, Benefit',
                                'input-ekspektasi': 'Tulis harapan Anda...',
                                'input-kursus_sebelumnya_detail': 'Contoh: IELTS 6.5',
                                'input-catatan': 'Informasi lain yang ingin Anda sampaikan...'
                            },
                            helps: {
                                'alamat_help': 'Untuk negara selain Indonesia, tulis alamat lengkap di sini.',
                                'lms_username_help': 'Username akan digunakan untuk akses LMS',
                                'lms_password_confirm_help': 'Pastikan password konfirmasi sama dengan password di sebelah kiri.'
                            },
                            options: {
                                'negara_studi_select': ['-- Pilih Negara --'],
                                'universitas_select': ['-- Pilih Universitas --'],
                                'program_level_select': ['-- Pilih Tingkat --'],
                                'program_level_pending': ['-- Pilih Kelas Terlebih Dahulu --'],
                                'jenis_kelamin': ['-- Pilih --','Laki-laki','Perempuan'],
                                'negara_select': ['Indonesia','United States','United Kingdom','Australia','Canada','Singapore','Malaysia','Other'],
                                'provinsi_select': ['-- Pilih Provinsi --'],
                                'kota_select': ['-- Pilih Kabupaten/Kota --'],
                                'kecamatan_select': ['-- Pilih Kecamatan --'],
                                'kelurahan_select': ['-- Pilih Kelurahan/Desa --'],
                                'status': ['-- Pilih --','Pelajar SMA','Mahasiswa','Fresh Graduate','Bekerja','Tidak Bekerja / Gap Year'],
                                'level': ['-- Pilih --','SMA/SMK','D3','S1','S2','S3'],
                                'industri_select': ['-- Pilih --','Pendidikan','Teknologi','Keuangan','Manufaktur','Healthcare','Government','Lainnya'],
                                'jenjang_select': ['-- Pilih --','S1','S2','S3'],
                                'program_select': [
                                    '-- Pilih --','IELTS','SAT','GMAT','GRE','TOEFL','TOEFL iBT','PTE','IGCSE','TOEIC','GED','A-Level','AS-Level','O-Level','IB','LSAT','UTBK','Scholarship','Ausbildung','General English','Business English','BIPA','JLPT','HSK','TOPIK','DELF','TestDaF','Duolingo','Belum Tahu / Butuh Konsultasi'
                                ],
                                'tes_tambahan_select': ['-- Pilih --','Ya','Tidak','Belum Yakin'],
                                'intake_select': ['-- Pilih --','Januari - Maret','April - Juni','Juli - September','Oktober - Desember','Belum Pasti'],
                                'jadwal_select': ['-- Pilih --','Private','Semi-private','Group','Paket'],
                                'program_intensif_select': ['-- Pilih --','Ya','Tidak','Tergantung Rekomendasi Tutor']
                            }
                        }
                    },
                    en: {
                        formTitle: 'Registration Form',
                        otherOption: 'Other (Enter manually)',
                        sectionTitles: [
                            'Basic Information',
                            'Employment Information',
                            'Program Purpose',
                            'Further Study/Work Information',
                            'Class Preferences & Expectations',
                            'Payment & LMS Access'
                        ],
                        progress: ['Basic','Employment','Purpose','Study/Work','Preferences','Payment'],
                        btnPrev: '← Previous',
                        btnNext: 'Next →',
                        btnSubmit: 'Submit Registration',
                        alamatHint: 'For countries other than Indonesia, write the full address here.',
                        fileHint: 'Format: JPG, PNG, or PDF. Max 5MB',
                        chooseFile: 'Choose File',
                        dropzoneText: 'Drag & drop here',
                        dropzoneOr: 'or',
                        fileView: 'View',
                        fileRemove: 'Remove',
                        dropzoneError: 'Payment proof file is required',
                        successSubmission: 'Success! Your data has been submitted. Our team will contact you shortly.',
                        viewPaymentPDF: 'View Payment Proof (PDF)',
                        downloadPayment: 'Download Payment Proof',
                        toast: {
                            fieldRequired: '{field} is required',
                            passwordMismatch: 'Password confirmation does not match',
                            passwordTooShort: 'LMS password must be at least 8 characters',
                            fileRequired: 'You must upload the payment proof',
                            validationMissing: '⚠ Please fill all required fields',
                            genericError: 'Error: {msg}'
                        },
                        passwordShow: 'Show',
                        passwordHide: 'Hide',
                        passwordHelpWeak: 'Weak — use at least 8 characters with a mix of letters and numbers.',
                        passwordHelpMedium: 'Medium — add symbols or capital letters.',
                        passwordHelpStrong: 'Strong — good!',
                        fields: {
                            labels: {
                                'label-nama': 'Full Name *',
                                'label-email': 'Active Email *',
                                'label-nohp': 'WhatsApp Number *',
                                'label-jk': 'Gender *',
                                'label-negara': 'Country *',
                                'label-provinsi': 'Province *',
                                'label-kabupaten': 'City/District *',
                                'label-kecamatan': 'Subdistrict *',
                                'label-kelurahan': 'Village/Suburb *',
                                'label-tgllahir': 'Date of Birth *',
                                'label-alamat': 'Full Address *',
                                'label-kontakdarurat': 'Emergency Contact Name *',
                                'label-nokontakdarurat': 'Emergency Contact Number *',
                                'label-status': 'Current Status *',
                                'label-pendidikan': 'Last Education *',
                                'label-status_kerja': 'Currently Working? *',
                                'label-kerja_ya': 'Yes',
                                'label-kerja_tidak': 'No',
                                'label-perusahaan': 'Company/Institution Name',
                                'label-posisi': 'Position/Title',
                                'label-industri': 'Industry',
                                'label-tujuan_utama': 'Main Purpose for Taking the Course *',
                                'label-tujuan1': 'Education (Study Abroad/Domestic)',
                                'label-tujuan2': 'Employment / Career',
                                'label-tujuan3': 'Migration',
                                'label-tujuan4': 'Personal Development',
                                'label-jenjang': 'Target Education Level',
                                'label-program': 'Test / Program to Prepare For *',
                                'label-rencana_tes': 'When do you plan to take the official test?',
                                'label-target_skor': 'Target score you want to achieve',
                                'label-skor_awal': 'Initial score (if any)',
                                'label-tes_tambahan': 'Need Additional Tests Besides Main Test?',
                                'label-negara_studi': 'Target Study Country',
                                'label-universitas': 'Target University (if any)',
                                'label-program_studi': 'Target Study Program',
                                'label-intake': 'Estimated Intake',
                                'label-negara_kerja': 'Target Work Country',
                                'label-bidang_industri_target': 'Target Field/Industry',
                                'label-kendala': 'Main Current Difficulties',
                                'label-kendala1': 'Speaking',
                                'label-kendala2': 'Writing',
                                'label-kendala3': 'Reading',
                                'label-kendala4': 'Listening',
                                'label-kendala5': 'Grammar',
                                'label-kendala6': 'Study Consistency',
                                'label-kendala9': 'Other',
                                'label-jadwal': 'Class Preference *',
                                'label-alasan_memilih': 'Reason for Choosing Ultimate Education',
                                'label-ekspektasi': 'Your Expectations After the Program',
                                'label-advisor': 'Would you like to be contacted by our Academic Advisor?',
                                'label-advisor_ya': 'Yes',
                                'label-advisor_tidak': 'No',
                                'label-kursus_sebelumnya': 'Have you taken preparatory courses before?',
                                'label-kursus_ya': 'Yes',
                                'label-kursus_tidak': 'No',
                                'label-kursus_detail': 'Which test & last score (if any)',
                                'label-catatan': 'Additional Notes',
                                'label-program_level': 'Program Level *',
                                'label-program_intensif': 'Willing for Intensive Program? *',
                                'label-bukti_pembayaran': 'Upload Payment Proof *',
                                'label-lms_username': 'LMS Username *',
                                'label-lms_password': 'LMS Password *',
                                'label-lms_password_confirm': 'LMS Password Confirmation *'
                            },
                            placeholders: {
                                'input-nohp': '628xxxxxxxxxx',
                                'input-tgllahir': 'dd/mm/yyyy',
                                'alamat_textarea': 'Street... No..., RT/RW, etc.',
                                'kendala_lain_input': 'Describe difficulty (optional)',
                                'negara_studi_other': 'Enter another country...',
                                'universitas_target_other': 'Enter university...',
                                'lms_username': 'Enter desired username',
                                'lms_password': 'At least 8 characters',
                                'lms_password_confirm': 'Repeat password',
                                'input-program_studi': 'E.g., Computer Science, Business',
                                'input-negara_kerja': 'Eg: Singapore, Australia',
                                'input-bidang_industri_target': 'Eg: IT, Finance, Education',
                                'input-alasan_memilih': 'Eg: Affordable, Location, Benefits',
                                'input-ekspektasi': 'Write your expectations...',
                                'input-kursus_sebelumnya_detail': 'Eg: IELTS 6.5',
                                'input-catatan': 'Any additional info you want to share...'
                            },
                            helps: {
                                'alamat_help': 'For countries other than Indonesia, write the full address here.',
                                'lms_username_help': 'Username will be used to access the LMS',
                                'lms_password_confirm_help': 'Ensure the confirmation password matches the password to the left.'
                            },
                            options: {
                                'negara_studi_select': ['-- Select Country --'],
                                'universitas_select': ['-- Select University --'],
                                'program_level_select': ['-- Select Level --'],
                                'program_level_pending': ['-- Select Class First --'],
                                'jenis_kelamin': ['-- Select --','Male','Female'],
                                'negara_select': ['Indonesia','United States','United Kingdom','Australia','Canada','Singapore','Malaysia','Other'],
                                'provinsi_select': ['-- Select Province --'],
                                'kota_select': ['-- Select City/District --'],
                                'kecamatan_select': ['-- Select Subdistrict --'],
                                'kelurahan_select': ['-- Select Village/Suburb --'],
                                'status': ['-- Select --','High School Student','University Student','Fresh Graduate','Employed','Unemployed / Gap Year'],
                                'level': ['-- Select --','High School','Diploma','Bachelor','Master','Doctorate'],
                                'industri_select': ['-- Select --','Education','Technology','Finance','Manufacturing','Healthcare','Government','Other'],
                                'jenjang_select': ['-- Select --','Bachelor','Master','Doctorate'],
                                'program_select': [
                                    '-- Select --','IELTS','SAT','GMAT','GRE','TOEFL','TOEFL iBT','PTE','IGCSE','TOEIC','GED','A-Level','AS-Level','O-Level','IB','LSAT','UTBK','Scholarship','Ausbildung','General English','Business English','BIPA','JLPT','HSK','TOPIK','DELF','TestDaF','Duolingo','Not sure / Need consultation'
                                ],
                                'tes_tambahan_select': ['-- Select --','Yes','No','Not sure'],
                                'intake_select': ['-- Select --','Jan - Mar','Apr - Jun','Jul - Sep','Oct - Dec','Not sure'],
                                'jadwal_select': ['-- Select --','Private','Semi-private','Group','Package'],
                                'program_intensif_select': ['-- Select --','Yes','No','Depends on tutor recommendation'],
                            }
                        }
                    }
                };
                // Supabase configuration (client-side). Replace with your project values.
                const SUPABASE_URL = 'https://rbivamtmcadfnemqcvac.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJiaXZhbXRtY2FkZm5lbXFjdmFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTU2MjgsImV4cCI6MjA4MTM5MTYyOH0.hZTprt4i3Y896uY_7m-lz-8T01lAArfj7hBIxw1utnc';
                let currentLang = 'id';
                function setLanguage(lang) {
                    currentLang = lang;
                    // Title
                    document.getElementById('form-title').textContent = langDict[lang].formTitle;
                    // Section titles
                    document.querySelectorAll('.section-title').forEach((el, i) => {
                        el.textContent = langDict[lang].sectionTitles[i] || el.textContent;
                    });
                    // Progress bar
                    document.querySelectorAll('.progress-label').forEach((el, i) => {
                        el.textContent = langDict[lang].progress[i] || el.textContent;
                    });
                    // Buttons
                    document.getElementById('btnPrev').textContent = langDict[lang].btnPrev;
                    document.getElementById('btnNext').textContent = langDict[lang].btnNext;
                    document.getElementById('btnSubmit').textContent = langDict[lang].btnSubmit;
                    // Alamat hint
                    const alamatHint = document.querySelector('textarea#alamat_textarea + small');
                    if (alamatHint) alamatHint.textContent = langDict[lang].alamatHint;
                    // Dropzone hint
                    const dropzoneHint = document.querySelector('.dropzone-hint');
                    if (dropzoneHint) dropzoneHint.textContent = langDict[lang].fileHint;
                    // Dropzone choose file
                    const chooseFileBtn = document.getElementById('chooseFileBtn');
                    if (chooseFileBtn) chooseFileBtn.textContent = langDict[lang].chooseFile;
                    // Dropzone drag text
                    const dropzoneInner = document.getElementById('dropzone_inner');
                    if (dropzoneInner) {
                        const s = dropzoneInner.querySelector('p strong');
                        if (s) s.textContent = langDict[lang].dropzoneText;
                        const orEl = document.getElementById('dropzone_or');
                        if (orEl) orEl.textContent = (langDict[lang].dropzoneOr || 'atau');
                    }
                    // Password help
                    const passwordHelp = document.getElementById('password_help');
                    if (passwordHelp) {
                        passwordHelp.textContent = langDict[lang].passwordHelpWeak;
                    }
                    // Preview / Remove buttons (if a file is already present)
                    const previewBtn = document.getElementById('preview_bukti_btn');
                    const removeBtn = document.getElementById('remove_bukti_btn');
                    if (previewBtn) previewBtn.textContent = (langDict[lang].fileView) || previewBtn.textContent;
                    if (removeBtn) removeBtn.textContent = (langDict[lang].fileRemove) || removeBtn.textContent;
                    // === FORM FIELD LABELS, PLACEHOLDERS, OPTIONS ===
                    const fieldMap = langDict[lang].fields;
                    if (!fieldMap) return;
                    // Labels (preserve required span)
                    Object.entries(fieldMap.labels).forEach(([id, text]) => {
                        const el = document.getElementById(id);
                        if (el) {
                            const html = (text || '').replace('*', ' <span class="required">*</span>');
                            el.innerHTML = html;
                        }
                    });
                    // Placeholders
                    Object.entries(fieldMap.placeholders).forEach(([id, text]) => {
                        const el = document.getElementById(id);
                        if (el) el.placeholder = text;
                    });
                    // Help texts
                    Object.entries(fieldMap.helps).forEach(([id, text]) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = text;
                    });
                    // Select options
                    Object.entries(fieldMap.options).forEach(([selectId, opts]) => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            Array.from(select.options).forEach((opt, i) => {
                                if (opts[i]) opt.textContent = opts[i];
                            });
                        }
                    });
                    // Re-seed dynamic study country/university lists so placeholders/other label update
                    try {
                        if (typeof seedStudyCountrySelect === 'function') seedStudyCountrySelect();
                        const cur = (typeof negaraStudiSelect !== 'undefined') ? (negaraStudiSelect && negaraStudiSelect.value) : null;
                        if (cur && typeof negaraStudiSelect !== 'undefined') {
                            // trigger change to refresh university list labels
                            negaraStudiSelect.dispatchEvent(new Event('change'));
                        }
                    } catch (e) {
                        // ignore
                    }
                }
                // Bind language switch (flag toggle)
                const langSwitchEl = document.getElementById('lang-switch');
                if (langSwitchEl) {
                    // checked = English, unchecked = Indonesian
                    langSwitchEl.addEventListener('change', (e) => {
                        setLanguage(e.target.checked ? 'en' : 'id');
                        // animate flags handled by CSS; no inner HTML swap needed
                        const label = document.querySelector('label[for="lang-switch"]');
                        if (label) {
                            // toggle aria-label for screen readers
                            label.setAttribute('aria-label', e.target.checked ? 'English' : 'Bahasa Indonesia');
                        }
                    });
                    // init default language (Indonesia)
                    langSwitchEl.checked = false;
                }
                // Init default
                setLanguage('id');
                // ...existing code...
        let currentSection = 1;
        const totalSections = 6;
        const form = document.getElementById('studentForm');
        const messageEl = document.getElementById('message');
        const loadingEl = document.getElementById('loading');
        const btnNext = document.getElementById('btnNext');
        const btnPrev = document.getElementById('btnPrev');
        const btnSubmit = document.getElementById('btnSubmit');
        const MAX_TEXT_LENGTH = 500;
        // Basic sanitizers to mitigate XSS/SQLi payload attempts on the client side
        const stripTags = (value = '') => value.replace(/<[^>]*>/g, '');
        const dropControlChars = (value = '') => value.replace(/[\u0000-\u001f\u007f]/g, '');
        const sanitizeText = (value = '') => dropControlChars(stripTags(value)).trim().slice(0, MAX_TEXT_LENGTH);
        const allowLists = {
            jenis_kelamin: ['Laki-laki', 'Perempuan'],
            status: ['Pelajar SMA', 'Mahasiswa', 'Fresh Graduate', 'Bekerja', 'Tidak Bekerja / Gap Year'],
            level: ['SMA/SMK', 'D3', 'S1', 'S2', 'S3'],
            program: ['IELTS','SAT','GMAT','GRE','TOEFL','TOEFL iBT','PTE','IGCSE','TOEIC','GED','A-Level','AS-Level','O-Level','IB','LSAT','UTBK','Scholarship','Ausbildung','General English','Business English','BIPA','JLPT','HSK','TOPIK','DELF','TestDaF','Duolingo','Belum Tahu'],
            tes_tambahan: ['Ya', 'Tidak', 'Belum Yakin'],
            jadwal: ['Private', 'Semi-private', 'Group', 'Paket'],
            program_intensif: ['Ya', 'Tidak', 'Tergantung rekomendasi tutor'],
            screening: ['Ya', 'Tidak'],
            intake: ['Jan–Mar', 'Apr–Jun', 'Jul–Sep', 'Oct–Dec', 'Belum Pasti'],
            program_level: ['Bronze', 'Silver', 'Gold', 'Premium'],
            negara: ['Indonesia', 'United States', 'United Kingdom', 'Australia', 'Canada', 'Singapore', 'Malaysia', 'Other']
        };
        const validateFile = (file) => {
            if (!file) return { ok: false, reason: 'File bukti pembayaran wajib diunggah' };
            const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
            if (!allowedTypes.includes(file.type)) {
                return { ok: false, reason: 'Format file harus JPG, PNG, atau PDF' };
            }
            if (file.size > 5 * 1024 * 1024) {
                return { ok: false, reason: 'Ukuran file maksimal 5MB' };
            }
            return { ok: true };
        };
        const sanitizeMultiValue = (values = []) => values.map(v => sanitizeText(v)).filter(Boolean);
        function validateAndSanitize(formData) {
            // Validate allowlisted select fields
            for (const key of Object.keys(allowLists)) {
                if (formData.has(key)) {
                    const val = formData.get(key);
                    if (val && !allowLists[key].includes(val)) {
                        return { error: `Pilihan untuk ${key} tidak valid` };
                    }
                }
            }
            // Email & telepon format checks
            const email = formData.get('email');
            const phone = formData.get('no_hp');
            const emailRegex = /^[\w.!#$%&'*+/=?`{|}~-]+@[\w-]+(\.[\w-]+)+$/;
            const phoneRegex = /^\d{9,15}$/;
            if (email && !emailRegex.test(email.trim())) {
                return { error: 'Format email tidak valid' };
            }
            if (phone && !phoneRegex.test(phone.trim().replace(/\s|\+/g, ''))) {
                return { error: 'Format nomor WhatsApp harus angka (9-15 digit)' };
            }
            // Password length basic policy
            const pwd = formData.get('lms_password') || '';
            if (pwd.length < 8) {
                const t = (langDict && langDict[currentLang] && langDict[currentLang].toast) ? langDict[currentLang].toast : null;
                return { error: (t && t.passwordTooShort) ? t.passwordTooShort : 'Password LMS minimal 8 karakter' };
            }
            // File check
            const fileCheck = validateFile(formData.get('bukti_pembayaran'));
            if (!fileCheck.ok) {
                return { error: fileCheck.reason };
            }
            // Sanitize text-ish fields
            const textFields = [
                'nama','kota','provinsi','negara','alamat','perusahaan','posisi','industri',
                'jenjang_pendidikan','rencana_tes','target_skor','kursus_sebelumnya_detail',
                'alasan_memilih','ekspektasi','program_studi','universitas_target','negara_studi',
                'negara_kerja','bidang_industri_target','catatan','lms_username','lms_password',
                'lms_password_confirm','nama_kontak_darurat','kontak_darurat','bidang_industri_target',
                'kecamatan','kelurahan'
            ];
            const sanitized = {};
            textFields.forEach(field => {
                if (formData.has(field)) {
                    sanitized[field] = sanitizeText(formData.get(field));
                }
            });
            // Preserve allowlist select values
            Object.keys(allowLists).forEach(key => {
                if (formData.has(key)) {
                    sanitized[key] = formData.get(key) || null;
                }
            });
            sanitized.no_hp = phone ? phone.trim().replace(/\\s|\\+/g, '') : null;
            sanitized.email = email ? email.trim() : null;
            sanitized.tes_tambahan_detail = sanitizeMultiValue(formData.getAll('tes_tambahan_detail')).join(', ') || null;
            sanitized.tujuan = sanitizeMultiValue(formData.getAll('tujuan'));
            sanitized.kendala = sanitizeMultiValue(formData.getAll('kendala'));
            // Jika user input custom "lainnya", pastikan tidak rangkap di array kendala
            try {
                const kendalaLainEl = document.getElementById('kendala_lain_input');
                const kendalaLainText = kendalaLainEl && kendalaLainEl.value ? sanitizeText(kendalaLainEl.value) : null;
                if (kendalaLainText) {
                    // Hapus semua value yang sama dengan input manual (case-insensitive)
                    sanitized.kendala = sanitized.kendala.filter(k => (k || '').toLowerCase() !== kendalaLainText.toLowerCase());
                    // Hapus juga placeholder 'lain lain', 'lain-lain', 'lainnya', 'lain'
                    sanitized.kendala = sanitized.kendala.filter(k => { const kk = (k || '').toLowerCase(); return kk !== 'lain lain' && kk !== 'lain-lain' && kk !== 'lainnya' && kk !== 'lain'; });
                    sanitized.kendala.push(kendalaLainText);
                }
            } catch (e) {
                // ignore DOM errors
            }
            sanitized.tanggal_lahir = formData.get('tanggal_lahir') || null;
            sanitized.tanggal_rencana_tes = formData.get('rencana_tes') || null;
            sanitized.skor_awal = formData.get('skor_awal') || null;
            sanitized.intake = formData.get('intake') || null;
            sanitized.status_kerja = formData.get('status_kerja') || null;
            sanitized.kursus_sebelumnya = formData.get('kursus_sebelumnya') || null;
            sanitized.program_level = formData.get('program_level') || null;
            sanitized.jadwal = formData.get('jadwal') || null;
            sanitized.program = formData.get('program') || null;
            sanitized.status = formData.get('status') || null;
            sanitized.level = formData.get('level') || null;
            sanitized.kota = formData.get('kota') || null;
            sanitized.provinsi = formData.get('provinsi') || null;
            sanitized.kecamatan = formData.get('kecamatan') || null;
            sanitized.kelurahan = formData.get('kelurahan') || null;
            // If selects store ids as values, use the visible text for human-readable names
            try {
                sanitized.provinsi = (provinsiSelect && provinsiSelect.selectedOptions[0] && provinsiSelect.selectedOptions[0].textContent) || sanitized.provinsi;
                sanitized.kota = (kotaSelect && kotaSelect.selectedOptions[0] && kotaSelect.selectedOptions[0].textContent) || sanitized.kota;
                sanitized.kecamatan = (kecamatanSelect && kecamatanSelect.selectedOptions[0] && kecamatanSelect.selectedOptions[0].textContent) || sanitized.kecamatan;
                sanitized.kelurahan = (kelurahanSelect && kelurahanSelect.selectedOptions[0] && kelurahanSelect.selectedOptions[0].textContent) || sanitized.kelurahan;
            } catch (e) {
                // ignore if DOM access fails in rare test contexts
            }
            return { data: sanitized };
        }
        // Toast helper
        function showToast(message, type = 'error', timeout = 4500) {
            try {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`.trim();
                toast.setAttribute('role', 'status');
                toast.setAttribute('aria-live', 'polite');
                const msg = document.createElement('div');
                msg.className = 'msg';
                msg.textContent = message;
                const close = document.createElement('button');
                close.className = 'close';
                close.type = 'button';
                close.setAttribute('aria-label', 'Tutup');
                close.innerHTML = '×';
                close.addEventListener('click', () => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 180);
                });
                toast.appendChild(msg);
                toast.appendChild(close);
                container.appendChild(toast);
                // show
                requestAnimationFrame(() => toast.classList.add('show'));
                // auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 200);
                }, timeout);
            } catch (e) {
                console.error('Toast error', e);
            }
        }
        // Wilayah Indonesia data loader
        const regionCache = {
            provinces: [],
            regencies: {},
            districts: {},
            villages: {}
        };
        const negaraSelect = document.getElementById('negara_select');
        const provinsiSelect = document.getElementById('provinsi_select');
        const kotaSelect = document.getElementById('kota_select');
        const kecamatanSelect = document.getElementById('kecamatan_select');
        const kelurahanSelect = document.getElementById('kelurahan_select');
        const alamatTextarea = document.getElementById('alamat_textarea');

        const isIndonesia = () => negaraSelect.value === 'Indonesia';

        async function fetchJSON(url) {
            const res = await fetch(url);
            if (!res.ok) throw new Error('Gagal memuat data wilayah');
            return res.json();
        }
        const PROVINCE_FALLBACK = [
            { id: '11', name: 'Aceh' },
            { id: '12', name: 'Sumatera Utara' },
            { id: '13', name: 'Sumatera Barat' },
            { id: '14', name: 'Riau' },
            { id: '15', name: 'Jambi' },
            { id: '16', name: 'Sumatera Selatan' },
            { id: '17', name: 'Bengkulu' },
            { id: '18', name: 'Lampung' },
            { id: '19', name: 'Kepulauan Bangka Belitung' },
            { id: '21', name: 'Kepulauan Riau' },
            { id: '31', name: 'DKI Jakarta' },
            { id: '32', name: 'Jawa Barat' },
            { id: '33', name: 'Jawa Tengah' },
            { id: '34', name: 'DI Yogyakarta' },
            { id: '35', name: 'Jawa Timur' },
            { id: '36', name: 'Banten' },
            { id: '51', name: 'Bali' },
            { id: '52', name: 'Nusa Tenggara Barat' },
            { id: '53', name: 'Nusa Tenggara Timur' },
            { id: '61', name: 'Kalimantan Barat' },
            { id: '62', name: 'Kalimantan Tengah' },
            { id: '63', name: 'Kalimantan Selatan' },
            { id: '64', name: 'Kalimantan Timur' },
            { id: '65', name: 'Kalimantan Utara' },
            { id: '71', name: 'Sulawesi Utara' },
            { id: '72', name: 'Sulawesi Tengah' },
            { id: '73', name: 'Sulawesi Selatan' },
            { id: '74', name: 'Sulawesi Tenggara' },
            { id: '75', name: 'Gorontalo' },
            { id: '76', name: 'Sulawesi Barat' },
            { id: '81', name: 'Maluku' },
            { id: '82', name: 'Maluku Utara' },
            { id: '91', name: 'Papua' },
            { id: '92', name: 'Papua Barat' },
            { id: '93', name: 'Papua Selatan' },
            { id: '94', name: 'Papua Tengah' },
            { id: '95', name: 'Papua Pegunungan' }
        ];
        async function loadProvinces() {
            if (regionCache.provinces.length) return regionCache.provinces;
            try {
                const data = await fetchJSON('https://www.emsifa.com/api-wilayah-indonesia/api/provinces.json');
                regionCache.provinces = data;
                return data;
            } catch (err) {
                console.warn('Gagal fetch provinsi dari API, gunakan fallback lokal:', err);
                regionCache.provinces = PROVINCE_FALLBACK;
                return PROVINCE_FALLBACK;
            }
        }
        async function loadRegencies(provinceId) {
            if (regionCache.regencies[provinceId]) return regionCache.regencies[provinceId];
            const data = await fetchJSON(`https://www.emsifa.com/api-wilayah-indonesia/api/regencies/${provinceId}.json`);
            regionCache.regencies[provinceId] = data;
            return data;
        }
        async function loadDistricts(regencyId) {
            if (regionCache.districts[regencyId]) return regionCache.districts[regencyId];
            const data = await fetchJSON(`https://www.emsifa.com/api-wilayah-indonesia/api/districts/${regencyId}.json`);
            regionCache.districts[regencyId] = data;
            return data;
        }
        async function loadVillages(districtId) {
            if (regionCache.villages[districtId]) return regionCache.villages[districtId];
            const data = await fetchJSON(`https://www.emsifa.com/api-wilayah-indonesia/api/villages/${districtId}.json`);
            regionCache.villages[districtId] = data;
            return data;
        }
        function setSelectOptions(selectEl, items, placeholder) {
            selectEl.innerHTML = `<option value="">${placeholder}</option>`;
            if (!items || !items.length) return;
            items.forEach(item => {
                // create elements instead of appending to innerHTML to avoid parsing inconsistencies
                const opt = document.createElement('option');
                // Prefer stable id as the option value so handlers can use option.value directly
                opt.value = item.id || item.value || item.code || item.kode || item.name;
                opt.textContent = item.name || item.label || opt.value;
                opt.dataset.name = item.name || opt.textContent;
                opt.dataset.id = item.id || opt.value;
                selectEl.appendChild(opt);
            });
        }
        function resetBelow(level) {
            if (level === 'provinsi' || !level) {
                setSelectOptions(kotaSelect, [], (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kota_select && langDict[currentLang].fields.options.kota_select[0]) || '-- Pilih Kabupaten/Kota --');
                setSelectOptions(kecamatanSelect, [], (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kecamatan_select && langDict[currentLang].fields.options.kecamatan_select[0]) || '-- Pilih Kecamatan --');
                setSelectOptions(kelurahanSelect, [], (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kelurahan_select && langDict[currentLang].fields.options.kelurahan_select[0]) || '-- Pilih Kelurahan/Desa --');
            }
            if (level === 'kota') {
                setSelectOptions(kecamatanSelect, [], (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kecamatan_select && langDict[currentLang].fields.options.kecamatan_select[0]) || '-- Pilih Kecamatan --');
                setSelectOptions(kelurahanSelect, [], (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kelurahan_select && langDict[currentLang].fields.options.kelurahan_select[0]) || '-- Pilih Kelurahan/Desa --');
            }
            if (level === 'kecamatan') {
                setSelectOptions(kelurahanSelect, [], (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kelurahan_select && langDict[currentLang].fields.options.kelurahan_select[0]) || '-- Pilih Kelurahan/Desa --');
            }
        }
        function seedProvinces() {
            // Isi fallback dulu supaya user langsung lihat daftar
            setSelectOptions(provinsiSelect, PROVINCE_FALLBACK, (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.provinsi_select && langDict[currentLang].fields.options.provinsi_select[0]) || '-- Pilih Provinsi --');
            // Coba refresh dari API; jika gagal, fallback sudah ada
            loadProvinces()
                .then(data => {
                    if (Array.isArray(data) && data.length) {
                        setSelectOptions(provinsiSelect, data, (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.provinsi_select && langDict[currentLang].fields.options.provinsi_select[0]) || '-- Pilih Provinsi --');
                    }
                })
                .catch(err => {
                    console.warn('Gagal memuat provinsi dari API, gunakan fallback:', err);
                    setSelectOptions(provinsiSelect, PROVINCE_FALLBACK, (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.provinsi_select && langDict[currentLang].fields.options.provinsi_select[0]) || '-- Pilih Provinsi --');
                });
        }
        function toggleIndonesiaFields() {
            const show = isIndonesia();
            [provinsiSelect, kotaSelect, kecamatanSelect, kelurahanSelect].forEach(el => {
                el.closest('.form-group').classList.toggle('hidden-field', !show);
                el.required = show;
                if (!show) el.value = '';
            });
            if (show) {
                seedProvinces();
            } else {
                resetBelow();
            }
        }

        negaraSelect.addEventListener('change', () => {
            toggleIndonesiaFields();
        });
        provinsiSelect.addEventListener('change', async (e) => {
            const option = e.target.selectedOptions[0];
            resetBelow('provinsi');
            const provinceId = option?.dataset?.id || option?.value;
            if (!provinceId) return;
            try {
                const regencies = await loadRegencies(provinceId);
                setSelectOptions(kotaSelect, regencies, (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kota_select && langDict[currentLang].fields.options.kota_select[0]) || '-- Pilih Kabupaten/Kota --');
            } catch (err) {
                messageEl.classList.add('error');
                messageEl.style.display = 'block';
                messageEl.textContent = 'Gagal memuat kabupaten/kota: ' + err.message;
            }
        });
        kotaSelect.addEventListener('change', async (e) => {
            const option = e.target.selectedOptions[0];
            resetBelow('kota');
            const regencyId = option?.dataset?.id || option?.value;
            if (!regencyId) return;
            try {
                const districts = await loadDistricts(regencyId);
                setSelectOptions(kecamatanSelect, districts, (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kecamatan_select && langDict[currentLang].fields.options.kecamatan_select[0]) || '-- Pilih Kecamatan --');
            } catch (err) {
                messageEl.classList.add('error');
                messageEl.style.display = 'block';
                messageEl.textContent = 'Gagal memuat kecamatan: ' + err.message;
            }
        });
        kecamatanSelect.addEventListener('change', async (e) => {
            const option = e.target.selectedOptions[0];
            resetBelow('kecamatan');
            const districtId = option?.dataset?.id || option?.value;
            if (!districtId) return;
            try {
                const villages = await loadVillages(districtId);
                setSelectOptions(kelurahanSelect, villages, (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.kelurahan_select && langDict[currentLang].fields.options.kelurahan_select[0]) || '-- Pilih Kelurahan/Desa --');
            } catch (err) {
                messageEl.classList.add('error');
                messageEl.style.display = 'block';
                messageEl.textContent = 'Gagal memuat kelurahan: ' + err.message;
            }
        });

        // Toggle field pekerjaan
        document.querySelectorAll('input[name="status_kerja"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const fieldPerusahaan = document.getElementById('field_perusahaan');
                const fieldPosisi = document.getElementById('field_posisi');
               
                if (e.target.value === 'Ya') {
                    fieldPerusahaan.classList.remove('hidden-field');
                    fieldPosisi.classList.remove('hidden-field');
                } else {
                    fieldPerusahaan.classList.add('hidden-field');
                    fieldPosisi.classList.add('hidden-field');
                }
            });
        });
        // Toggle field kursus sebelumnya
        document.querySelectorAll('input[name="kursus_sebelumnya"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const fieldKursusBefore = document.getElementById('field_kursus_sebelumnya');

                if (e.target.value === 'Ya') {
                    fieldKursusBefore.classList.remove('hidden-field');
                } else {
                    fieldKursusBefore.classList.add('hidden-field');
                }
            });
        });
        // Toggle field tes tambahan
        document.querySelector('select[name="tes_tambahan"]').addEventListener('change', (e) => {
            const fieldTesTambahan = document.getElementById('field_tes_tambahan');

            if (e.target.value === 'Ya') {
                fieldTesTambahan.classList.remove('hidden-field');
            } else {
                fieldTesTambahan.classList.add('hidden-field');
            }
        });

        // Optional 'Lain lain' kendala handler: show input when checkbox checked
        (function() {
            const kendala9Checkbox = document.getElementById('kendala9');
            const kendalaLainInput = document.getElementById('kendala_lain_input');
            if (kendala9Checkbox && kendalaLainInput) {
                // initialize hidden and disabled state
                kendalaLainInput.classList.add('hidden-field');
                kendalaLainInput.disabled = true;
                kendala9Checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        kendalaLainInput.classList.remove('hidden-field');
                        kendalaLainInput.disabled = false;
                        kendalaLainInput.focus();
                    } else {
                        kendalaLainInput.classList.add('hidden-field');
                        kendalaLainInput.disabled = true;
                        kendalaLainInput.value = '';
                    }
                });
            }
        })();
        // Toggle field program level
        document.getElementById('jadwal_select').addEventListener('change', (e) => {
            const fieldProgramLevel = document.getElementById('field_program_level');
            const programLevelSelect = document.getElementById('program_level_select');

            if (e.target.value === 'Group' || e.target.value === 'Private' || e.target.value === 'Paket' || e.target.value === 'Semi-private') {
                fieldProgramLevel.classList.remove('hidden-field');
                programLevelSelect.innerHTML = `<option value="">${(langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.program_level_select && langDict[currentLang].fields.options.program_level_select[0]) || '-- Pilih Tingkat --'}</option>`;

                if (e.target.value === 'Group') {
                    programLevelSelect.innerHTML += '<option value="Bronze">Bronze</option>';
                    programLevelSelect.innerHTML += '<option value="Silver">Silver</option>';
                } else if (e.target.value === 'Private') {
                    programLevelSelect.innerHTML += '<option value="Silver">Silver</option>';
                    programLevelSelect.innerHTML += '<option value="Gold">Gold</option>';
                    programLevelSelect.innerHTML += '<option value="Premium">Premium</option>';
                } else if (e.target.value === 'Paket') {
                    programLevelSelect.innerHTML += '<option value="Bronze">Bronze</option>';
                    programLevelSelect.innerHTML += '<option value="Silver">Silver</option>';
                    programLevelSelect.innerHTML += '<option value="Gold">Gold</option>';
                } else if (e.target.value === 'Semi-private') {
                    programLevelSelect.innerHTML += '<option value="Bronze">Bronze</option>';
                    programLevelSelect.innerHTML += '<option value="Silver">Silver</option>';
                }
            } else {
                fieldProgramLevel.classList.add('hidden-field');
                programLevelSelect.innerHTML = `<option value="">${(langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.program_level_pending && langDict[currentLang].fields.options.program_level_pending[0]) || '-- Pilih Kelas Terlebih Dahulu --'}</option>`;
            }
        });

        // Study destination helpers: negara & universitas (top-10 per negara + "Lainnya")
        const negaraStudiSelect = document.getElementById('negara_studi_select');
        const negaraStudiOther = document.getElementById('negara_studi_other');
        const negaraStudiInput = document.getElementById('negara_studi_input');
        const universitasSelect = document.getElementById('universitas_select');
        const universitasOther = document.getElementById('universitas_target_other');
        const universitasInput = document.getElementById('universitas_target_input');

        const TOP_UNIVERSITIES = {
            'United States': ['Harvard University','Stanford University','Massachusetts Institute of Technology (MIT)','California Institute of Technology (Caltech)','Princeton University','Yale University','Columbia University','University of Chicago','University of Pennsylvania','Johns Hopkins University'],
            'United Kingdom': ['University of Oxford','University of Cambridge','Imperial College London','University College London (UCL)','London School of Economics and Political Science (LSE)','University of Edinburgh','University of Manchester','King\'s College London','University of Bristol','University of Warwick'],
            'Australia': ['Australian National University','University of Melbourne','University of Sydney','University of New South Wales','University of Queensland','Monash University','University of Western Australia','University of Adelaide','University of Technology Sydney','Macquarie University'],
            'Canada': ['University of Toronto','McGill University','University of British Columbia','University of Alberta','McMaster University','Universit\u00e9 de Montr\u00e9al','University of Waterloo','Western University','University of Ottawa','Queen\'s University'],
            'Germany': ['Ludwig-Maximilians-Universit\u00e4t M\u00fcnchen','Technische Universit\u00e4t M\u00fcnchen','Heidelberg University','Humboldt-Universit\u00e4t zu Berlin','Freie Universit\u00e4t Berlin','RWTH Aachen University','University of T\u00fcbingen','Karlsruhe Institute of Technology','Technical University of Berlin','Goethe University Frankfurt'],
            'Netherlands': ['Delft University of Technology','University of Amsterdam','Utrecht University','Eindhoven University of Technology','Wageningen University & Research','Leiden University','Erasmus University Rotterdam','Vrije Universiteit Amsterdam','Maastricht University','Radboud University'],
            'France': ['Universit\u00e9 Paris-Saclay','Sorbonne University','\u00c9cole Polytechnique','Universit\u00e9 PSL','University of Paris','Universit\u00e9 Grenoble Alpes','Universit\u00e9 de Lyon','\u00c9cole Normale Sup\u00e9rieure','Universit\u00e9 de Bordeaux','Universit\u00e9 de Strasbourg'],
            'New Zealand': ['University of Auckland','University of Otago','University of Canterbury','Victoria University of Wellington','Massey University','Auckland University of Technology','Lincoln University','University of Waikato','Southern Institute of Technology','Open Polytechnic of New Zealand'],
            'Singapore': ['National University of Singapore (NUS)','Nanyang Technological University (NTU)','Singapore Management University (SMU)','Singapore University of Technology and Design (SUTD)','Singapore Institute of Technology (SIT)','LASALLE College of the Arts','Nanyang Academy of Fine Arts (NAFA)','INSEAD (Asia Campus)','S P Jain School of Global Management','ESSEC Asia-Pacific'],
            'Japan': ['University of Tokyo','Kyoto University','Osaka University','Tohoku University','Nagoya University','Hokkaido University','Kyushu University','University of Tsukuba','Waseda University','Keio University']
        };

        function setSimpleOptions(selectEl, items, placeholder) {
            selectEl.innerHTML = `<option value="">${placeholder}</option>`;
            if (!items || !items.length) return;
            items.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                selectEl.appendChild(opt);
            });
            const otherOpt = document.createElement('option');
            otherOpt.value = 'other';
            otherOpt.textContent = (langDict && langDict[currentLang] && langDict[currentLang].otherOption) || 'Lainnya (Masukkan sendiri)';
            selectEl.appendChild(otherOpt);
        }

        function seedStudyCountrySelect() {
            const countries = Object.keys(TOP_UNIVERSITIES);
            const placeholder = (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.negara_studi_select && langDict[currentLang].fields.options.negara_studi_select[0]) || '-- Pilih Negara --';
            setSimpleOptions(negaraStudiSelect, countries, placeholder);
        }

        negaraStudiSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            negaraStudiOther.classList.toggle('hidden-field', val !== 'other' && val !== '');
            if (val === 'other') {
                const uniPlaceholder = (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.universitas_select && langDict[currentLang].fields.options.universitas_select[0]) || '-- Pilih Universitas --';
                universitasSelect.innerHTML = `<option value="">${uniPlaceholder}</option><option value="other">${(langDict && langDict[currentLang] && langDict[currentLang].otherOption) || 'Lainnya (Masukkan sendiri)'}</option>`;
                universitasOther.classList.remove('hidden-field');
                universitasInput.value = '';
                negaraStudiInput.value = '';
                negaraStudiOther.focus();
            } else if (!val) {
                const uniPlaceholder = (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.universitas_select && langDict[currentLang].fields.options.universitas_select[0]) || '-- Pilih Universitas --';
                universitasSelect.innerHTML = `<option value="">${uniPlaceholder}</option>`;
                universitasOther.classList.add('hidden-field');
                universitasInput.value = '';
                negaraStudiInput.value = '';
            } else {
                negaraStudiOther.classList.add('hidden-field');
                negaraStudiInput.value = val;
                const tops = TOP_UNIVERSITIES[val] || [];
                const uniPlaceholder = (langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.universitas_select && langDict[currentLang].fields.options.universitas_select[0]) || '-- Pilih Universitas --';
                setSimpleOptions(universitasSelect, tops, uniPlaceholder);
                universitasOther.classList.add('hidden-field');
                universitasInput.value = '';
            }
        });

        negaraStudiOther.addEventListener('input', (e) => {
            negaraStudiInput.value = e.target.value.trim();
        });

        universitasSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            if (val === 'other') {
                universitasOther.classList.remove('hidden-field');
                universitasInput.value = '';
                universitasOther.focus();
            } else if (!val) {
                universitasOther.classList.add('hidden-field');
                universitasInput.value = '';
            } else {
                universitasOther.classList.add('hidden-field');
                universitasInput.value = val;
            }
        });

        universitasOther.addEventListener('input', (e) => {
            universitasInput.value = e.target.value.trim();
        });

        // Initialize study selects
        seedStudyCountrySelect();
        negaraStudiOther.classList.add('hidden-field');
        universitasOther.classList.add('hidden-field');
        negaraStudiInput.value = '';
        universitasInput.value = '';

        // Navigation functions
        function showSection(sectionNum) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelector(`.form-section[data-section="${sectionNum}"]`).classList.add('active');
            // Update progress bar
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < sectionNum) {
                    step.classList.add('completed');
                } else if (index + 1 === sectionNum) {
                    step.classList.add('active');
                }
            });
            // Update buttons
            btnPrev.style.display = sectionNum === 1 ? 'none' : 'block';
            btnNext.style.display = sectionNum === totalSections ? 'none' : 'block';
            btnSubmit.style.display = sectionNum === totalSections ? 'block' : 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        btnNext.addEventListener('click', (e) => {
            e.preventDefault();
            if (validateCurrentSection()) {
                if (currentSection < totalSections) {
                    currentSection++;
                    showSection(currentSection);
                }
            }
        });
        btnPrev.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentSection > 1) {
                currentSection--;
                showSection(currentSection);
            }
        });
        function validateCurrentSection() {
            const currentSectionEl = document.querySelector(`.form-section[data-section="${currentSection}"]`);
            const requiredFields = currentSectionEl.querySelectorAll('[required]:not([type="checkbox"]):not([type="radio"])');
            const requiredGroups = new Set(Array.from(currentSectionEl.querySelectorAll('[required][type="radio"], [required][type="checkbox"]')).map(f => f.name));

            let isValid = true;

            // Special validation for section 6 (password confirmation)
            if (currentSection === 6) {
                const passwordField = currentSectionEl.querySelector('input[name="lms_password"]');
                const confirmPasswordField = currentSectionEl.querySelector('input[name="lms_password_confirm"]');
                if (passwordField.value !== confirmPasswordField.value) {
                    confirmPasswordField.style.borderColor = '#e74c3c';
                    isValid = false;
                } else {
                    confirmPasswordField.style.borderColor = '';
                }
            }
           
            // Validate text/email/tel/date/select/textarea
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#e74c3c';
                    isValid = false;
                } else {
                    field.style.borderColor = '';
                }
            });
           
            // Validate radio/checkbox groups
            requiredGroups.forEach(groupName => {
                const group = currentSectionEl.querySelectorAll(`[name="${groupName}"]`);
                const isChecked = Array.from(group).some(f => f.checked);
                if (!isChecked) {
                    group.forEach(f => f.style.accentColor = '#e74c3c');
                    isValid = false;
                } else {
                    group.forEach(f => f.style.accentColor = '#145DA0');
                }
            });
           
            if (!isValid) {
                // Use translations for toast messages
                const t = (langDict && langDict[currentLang] && langDict[currentLang].toast) ? langDict[currentLang].toast : {};
                let toastMsg = t.validationMissing || '⚠ Harap isi semua field yang wajib diisi';
                // Password mismatch
                if (currentSection === 6) {
                    const passwordField = currentSectionEl.querySelector('input[name="lms_password"]');
                    const confirmPasswordField = currentSectionEl.querySelector('input[name="lms_password_confirm"]');
                    if (passwordField && confirmPasswordField && passwordField.value !== confirmPasswordField.value) {
                        toastMsg = t.passwordMismatch || 'Konfirmasi password tidak sama';
                    }
                }
                // First empty input/textarea/select
                if (toastMsg === (t.validationMissing || '⚠ Harap isi semua field yang wajib diisi')) {
                    const emptyField = Array.from(requiredFields).find(f => !f.value.trim());
                    if (emptyField) {
                        let labelEl = null;
                        if (emptyField.id) labelEl = currentSectionEl.querySelector(`label[for="${emptyField.id}"]`);
                        if (!labelEl) {
                            const fg = emptyField.closest('.form-group');
                            if (fg) labelEl = fg.querySelector('label');
                        }
                        const labelText = labelEl ? labelEl.textContent.replace(/\*/g, '').trim() : (emptyField.name || (currentLang === 'en' ? 'This field' : 'Field ini'));
                        const template = t.fieldRequired || '{field} wajib diisi';
                        toastMsg = template.replace('{field}', labelText);
                    } else {
                        // radio/checkbox groups
                        for (const g of requiredGroups) {
                            const groupEls = currentSectionEl.querySelectorAll(`[name="${g}"]`);
                            const any = Array.from(groupEls).some(x => x.checked);
                            if (!any) {
                                let labelEl = groupEls[0] && groupEls[0].closest('.form-group') && groupEls[0].closest('.form-group').querySelector('label');
                                const labelText = labelEl ? labelEl.textContent.replace(/\*/g, '').trim() : (g || (currentLang === 'en' ? 'Selection' : 'Pilihan'));
                                const template = t.fieldRequired || '{field} wajib diisi';
                                toastMsg = template.replace('{field}', labelText);
                                break;
                            }
                        }
                    }
                }
                messageEl.classList.remove('success');
                messageEl.classList.add('error');
                messageEl.textContent = toastMsg;
                messageEl.style.display = 'block';
                showToast(toastMsg, 'error');
            } else {
                messageEl.style.display = 'none';
            }
            return isValid;
        }
        // Dropzone & LMS UI behaviors
        (function() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('bukti_pembayaran');
            const chooseBtn = document.getElementById('chooseFileBtn');
            const fileInfo = document.getElementById('bukti_file_info');
            const fileNameEl = document.getElementById('bukti_file_name');
            const removeBtn = document.getElementById('remove_bukti_btn');
            const previewBtn = document.getElementById('preview_bukti_btn');
            const errorEl = document.getElementById('bukti_error');

            function updateFileUI(file) {
                if (!file) {
                    fileInfo.style.display = 'none';
                    fileNameEl.textContent = '';
                    errorEl.style.display = 'none';
                    return;
                }
                fileInfo.style.display = 'flex';
                fileNameEl.textContent = `${file.name} (${Math.round(file.size/1024)} KB)`;
                // localize buttons when showing file
                try {
                    if (previewBtn) {
                        previewBtn.textContent = (langDict && langDict[currentLang] && langDict[currentLang].fileView) || previewBtn.textContent;
                        previewBtn.setAttribute('aria-label', previewBtn.textContent);
                    }
                    if (removeBtn) {
                        removeBtn.textContent = (langDict && langDict[currentLang] && langDict[currentLang].fileRemove) || removeBtn.textContent;
                        removeBtn.setAttribute('aria-label', removeBtn.textContent);
                    }
                } catch (e) {}
                errorEl.style.display = 'none';
            }

            function setFile(file) {
                if (!file) return;
                const check = validateFile(file);
                if (!check.ok) {
                    errorEl.textContent = check.reason;
                    errorEl.style.display = 'block';
                    fileInput.value = '';
                    updateFileUI(null);
                    return;
                }
                // Create a DataTransfer to set file input programmatically
                const dt = new DataTransfer();
                dt.items.add(file);
                fileInput.files = dt.files;
                updateFileUI(file);
            }

            chooseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => setFile(e.target.files[0]));

            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('dragover'); });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault(); dropzone.classList.remove('dragover');
                const file = e.dataTransfer.files && e.dataTransfer.files[0];
                if (file) setFile(file);
            });

            removeBtn.addEventListener('click', () => { fileInput.value = ''; updateFileUI(null); });
            previewBtn.addEventListener('click', () => {
                const file = fileInput.files && fileInput.files[0];
                if (!file) return;
                // If image, show in new tab; if pdf open
                const url = URL.createObjectURL(file);
                window.open(url, '_blank');
                setTimeout(() => URL.revokeObjectURL(url), 2000);
            });

            // Initialize if prefilled
            if (fileInput.files && fileInput.files[0]) updateFileUI(fileInput.files[0]);
        })();

        // Password toggle and strength
        (function() {
            const pw = document.getElementById('lms_password');
            const toggle = document.getElementById('togglePassword');
            const meterBar = document.getElementById('password_meter_bar');
            const passwordHelp = document.getElementById('password_help');

            function scorePassword(s) {
                let score = 0;
                if (!s) return 0;
                if (s.length >= 8) score += 1;
                if (/[A-Z]/.test(s)) score += 1;
                if (/[0-9]/.test(s)) score += 1;
                if (/[^A-Za-z0-9]/.test(s)) score += 1;
                return score; // 0-4
            }

            function updateMeter() {
                const score = scorePassword(pw.value);
                const percent = (score / 4) * 100;
                meterBar.style.width = percent + '%';
                if (score <= 1) {
                    meterBar.style.background = '#e74c3c';
                        passwordHelp.textContent = (langDict && langDict[currentLang] && langDict[currentLang].passwordHelpWeak) || 'Lemah — gunakan minimal 8 karakter dengan kombinasi huruf dan angka.';
                } else if (score === 2) {
                    meterBar.style.background = '#f1c40f';
                        passwordHelp.textContent = (langDict && langDict[currentLang] && langDict[currentLang].passwordHelpMedium) || 'Sedang — tambahkan simbol atau huruf kapital.';
                } else {
                    meterBar.style.background = '#2ecc71';
                        passwordHelp.textContent = (langDict && langDict[currentLang] && langDict[currentLang].passwordHelpStrong) || 'Kuat — baik!';
                }
            }

            toggle.addEventListener('click', () => {
                if (pw.type === 'password') {
                    pw.type = 'text';
                    toggle.textContent = 'Hide';
                } else {
                    pw.type = 'password';
                    toggle.textContent = 'Show';
                }
            });

            // Confirm password toggle
            const pwConfirm = document.getElementById('lms_password_confirm');
            const toggleConfirm = document.getElementById('togglePasswordConfirm');
            if (toggleConfirm && pwConfirm) {
                toggleConfirm.addEventListener('click', () => {
                    if (pwConfirm.type === 'password') {
                        pwConfirm.type = 'text';
                        toggleConfirm.textContent = 'Hide';
                    } else {
                        pwConfirm.type = 'password';
                        toggleConfirm.textContent = 'Show';
                    }
                });
            }

            pw.addEventListener('input', updateMeter);
            updateMeter();
        })();

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!validateCurrentSection()) {
                return;
            }
            loadingEl.style.display = 'block';
            messageEl.style.display = 'none';
            try {
                const formData = new FormData(form);
                const validation = validateAndSanitize(formData);
                if (validation.error) {
                    throw new Error(validation.error);
                }
                const safe = validation.data;
                // Gunakan alamat apa adanya, tidak digabung
                const fullAlamat = safe.alamat || '';

                // === UPLOAD FILE TO SUPABASE STORAGE ===
                const fileInput = document.getElementById('bukti_pembayaran');
                const file = fileInput.files[0];
                let buktiUrl = null;
                if (file) {
                    // Gunakan global supabase dari CDN
                    const { createClient } = supabase;
                    const client = createClient(SUPABASE_URL, SUPABASE_KEY);
                    // Nama file unik: timestamp_namaasli
                    const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.\-_]/g, '')}`;
                    const { data: uploadData, error: uploadError } = await client.storage.from('payment_proofs').upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                    if (uploadError) {
                        throw new Error('Gagal upload bukti pembayaran: ' + uploadError.message);
                    }
                    // Dapatkan public URL
                    const { data: publicUrlData } = client.storage.from('payment_proofs').getPublicUrl(fileName);
                    buktiUrl = publicUrlData.publicUrl;
                } else {
                    throw new Error('File bukti pembayaran tidak ditemukan');
                }

                const data = {
                    nama: safe.nama,
                    no_hp: safe.no_hp || null,
                    email: safe.email || null,
                    alamat: fullAlamat || null,
                    program: safe.program || null, // Program Tes yang Ingin Dipersiapkan
                    jenis_kelamin: safe.jenis_kelamin || null,
                    tanggal_lahir: safe.tanggal_lahir || null,
                    domisili_kota: safe.kota || null,
                    domisili_provinsi: safe.provinsi || null,
                    domisili_negara: safe.negara || null,
                    status_saat_ini: safe.status || null,
                    pendidikan_terakhir: safe.level || null,
                    apakah_bekerja: safe.status_kerja === 'Ya' ? true : false,
                    nama_perusahaan: safe.perusahaan || null,
                    posisi_jabatan: safe.posisi || null,
                    industri: safe.industri || null,
                    tujuan_utama: safe.tujuan && Array.isArray(safe.tujuan) ? safe.tujuan.join(', ') : (safe.tujuan || null),
                    target_jenjang: safe.jenjang_pendidikan || null,
                    butuh_tes_lain: safe.tes_tambahan || null,
                    rencana_tes: safe.rencana_tes || null,
                    target_skor: safe.target_skor || null,
                    pernah_kursus: safe.kursus_sebelumnya === 'Ya' ? true : false,
                    detail_kursus: safe.kursus_sebelumnya_detail || null,
                    kendala_utama: safe.kendala || null, // ARRAY
                    alasan_memilih: safe.alasan_memilih || null,
                    ekspektasi: safe.ekspektasi || null,
                    preferensi_kelas: safe.jadwal || null,
                    kesediaan_intensif: safe.program_intensif || null,
                    bersedia_screening: safe.screening === 'Ya' ? true : false,
                    studi_negara_tujuan: safe.negara_studi || null,
                    studi_univ_target: safe.universitas_target || null,
                    studi_prodi_target: safe.program_studi || null,
                    studi_intake: safe.intake || null,
                    kerja_negara_tujuan: safe.negara_kerja || null,
                    kerja_bidang_target: safe.bidang_industri_target || null,
                    tanggal_rencana_tes: safe.tanggal_rencana_tes || null,
                    prospect_status: 'none',
                    nama_kontak_darurat: safe.nama_kontak_darurat || null,
                    kontak_darurat: safe.kontak_darurat || null,
                    skor_awal: safe.skor_awal || null,
                    lms_username: safe.lms_username || null,
                    lms_password: safe.lms_password || null,
                    tingkat_program: safe.program_level || null,
                    tes_tambahan_detail: safe.tes_tambahan_detail || null,
                    bukti_pembayaran_url: buktiUrl,
                    kendala_lainnya: (typeof safe.kendala_lain !== 'undefined' ? safe.kendala_lain : null),
                    kecamatan: safe.kecamatan || null,
                    kelurahan: safe.kelurahan || null,
                    catatan: safe.catatan || null
                };
                // Cek apakah Supabase sudah dikonfigurasi
                if (SUPABASE_URL.includes('YOUR-') || SUPABASE_KEY.includes('YOUR-')) {
                    throw new Error('Supabase credentials belum dikonfigurasi. Ganti SUPABASE_URL dan SUPABASE_KEY dengan kredensial Anda.');
                }
                // Gunakan global supabase dari CDN
                const { createClient } = supabase;
                const client = createClient(SUPABASE_URL, SUPABASE_KEY);
                // Insert ke database
                const { data: insertedData, error } = await client
                    .from('marketing_retail')
                    .insert([data])
                    .select();
                if (error) {
                    throw new Error(error.message || 'Gagal menyimpan data');
                }
                loadingEl.style.display = 'none';
                messageEl.classList.remove('error');
                messageEl.classList.add('success');
                // Tampilkan preview/link file bukti pembayaran (gunakan terjemahan)
                let previewHtml = '';
                const tGlobal = (langDict && langDict[currentLang]) ? langDict[currentLang] : null;
                const successMsg = (tGlobal && tGlobal.successSubmission) ? tGlobal.successSubmission : 'Berhasil! Data Anda telah dikirim. Tim kami akan menghubungi Anda segera.';
                const viewPdfLabel = (tGlobal && tGlobal.viewPaymentPDF) ? tGlobal.viewPaymentPDF : 'Lihat Bukti Pembayaran (PDF)';
                const downloadLabel = (tGlobal && tGlobal.downloadPayment) ? tGlobal.downloadPayment : 'Download Bukti Pembayaran';
                if (buktiUrl) {
                    if (buktiUrl.match(/\.(jpg|jpeg|png)$/i)) {
                        previewHtml = `<br><img src="${buktiUrl}" alt="${viewPdfLabel}" style="max-width:320px;max-height:320px;margin-top:10px;border:1px solid #ccc;">`;
                    } else if (buktiUrl.match(/\.pdf$/i)) {
                        previewHtml = `<br><a href="${buktiUrl}" target="_blank" rel="noopener">${viewPdfLabel}</a>`;
                    } else {
                        previewHtml = `<br><a href="${buktiUrl}" target="_blank" rel="noopener">${downloadLabel}</a>`;
                    }
                }
                messageEl.innerHTML = successMsg + previewHtml;
                messageEl.style.display = 'block';
                // Reset form
                form.reset();
                currentSection = 1;
                showSection(1);
                document.getElementById('field_perusahaan').classList.add('hidden-field');
                document.getElementById('field_posisi').classList.add('hidden-field');
                document.getElementById('field_kursus_sebelumnya').classList.add('hidden-field');
                document.getElementById('field_tes_tambahan').classList.add('hidden-field');
                document.getElementById('field_program_level').classList.add('hidden-field');
                document.getElementById('program_level_select').innerHTML = `<option value="">${(langDict && langDict[currentLang] && langDict[currentLang].fields && langDict[currentLang].fields.options && langDict[currentLang].fields.options.program_level_pending && langDict[currentLang].fields.options.program_level_pending[0]) || '-- Pilih Kelas Terlebih Dahulu --'}</option>`;
            } catch (error) {
                loadingEl.style.display = 'none';
                const errMsg = error && error.message ? error.message : 'Terjadi kesalahan';
                messageEl.classList.remove('success');
                messageEl.classList.add('error');
                messageEl.textContent = 'Error: ' + errMsg;
                messageEl.style.display = 'block';
                // Use translated toast if it matches known cases
                const t = (langDict && langDict[currentLang] && langDict[currentLang].toast) ? langDict[currentLang].toast : null;
                let toastToShow = errMsg;
                if (t) {
                    if (/bukti/i.test(errMsg) || /payment proof/i.test(errMsg)) {
                        toastToShow = t.fileRequired || toastToShow;
                    } else {
                        toastToShow = (t.genericError || 'Error: {msg}').replace('{msg}', errMsg);
                    }
                }
                showToast(toastToShow, 'error');
                console.error('Error:', error);
            }
        });
        function buildCatatan(dataSafe) {
            const parts = [];
           
            parts.push(`Tanggal Lahir: ${dataSafe.tanggal_lahir || 'N/A'}`);
           
            if (dataSafe.tujuan && dataSafe.tujuan.length > 0) {
                parts.push('Tujuan: ' + dataSafe.tujuan.join(', '));
            }
           
            if (dataSafe.kendala && dataSafe.kendala.length > 0) {
                parts.push('Kendala: ' + dataSafe.kendala.join(', '));
            }
           
            if (dataSafe.status_kerja === 'Ya') {
                parts.push('Bekerja di: ' + (dataSafe.perusahaan || 'N/A'));
                parts.push('Posisi: ' + (dataSafe.posisi || 'N/A'));
                parts.push('Industri: ' + (dataSafe.industri || 'N/A'));
            } else {
                parts.push('Status Kerja: Tidak');
            }
           
            if (dataSafe.jenjang_pendidikan) {
                parts.push('Jenjang Target: ' + dataSafe.jenjang_pendidikan);
            }
           
            if (dataSafe.negara_studi) {
                parts.push('Negara Studi: ' + dataSafe.negara_studi);
            }
            if (dataSafe.universitas_target) {
                parts.push('Universitas Target: ' + dataSafe.universitas_target);
            }
            if (dataSafe.program_studi) {
                parts.push('Program Studi: ' + dataSafe.program_studi);
            }
            if (dataSafe.intake) {
                parts.push('Intake: ' + dataSafe.intake);
            }
           
            if (dataSafe.negara_kerja) {
                parts.push('Negara Kerja: ' + dataSafe.negara_kerja);
            }
            if (dataSafe.bidang_industri_target) {
                parts.push('Bidang Industri Target: ' + dataSafe.bidang_industri_target);
            }
           
            if (dataSafe.rencana_tes) {
                parts.push('Rencana Tes: ' + dataSafe.rencana_tes);
            }
           
            if (dataSafe.target_skor) {
                parts.push('Target Skor: ' + dataSafe.target_skor);
            }
           
            if (dataSafe.kursus_sebelumnya === 'Ya') {
                parts.push('Kursus Sebelumnya: ' + (dataSafe.kursus_sebelumnya_detail || 'N/A'));
            }
           
            parts.push('Program Intensif: ' + (dataSafe.program_intensif || 'N/A'));
            parts.push('Screening Advisor: ' + (dataSafe.screening || 'N/A'));
           
            if (dataSafe.ekspektasi) {
                parts.push('Ekspektasi: ' + dataSafe.ekspektasi);
            }
           
            if (dataSafe.catatan) {
                parts.push('Catatan Tambahan: ' + dataSafe.catatan);
            }
           
            return parts.join(' | ');
        }
        // Initialize first section & wilayah Indonesia dropdowns
        showSection(1);
        try {
            if (typeof toggleIndonesiaFields === 'function') {
                toggleIndonesiaFields();
            }
        } catch (e) {
            console.error('Gagal inisialisasi wilayah Indonesia:', e);
        }
    </script>
</body>
</html>